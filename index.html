<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Moments Hub — Tubonge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .radial-bg{background-image:
      radial-gradient(1200px 600px at 20% -10%, rgba(59,130,246,.10), transparent),
      radial-gradient(900px 400px at 90% -10%, rgba(217,70,239,.10), transparent)}
    .card{box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .chip{font-size:.7rem;padding:.2rem .5rem;border-radius:999px;background:rgba(0,0,0,.08)}
    .dropzone{border:1px dashed rgba(0,0,0,.15)}
    .story-ring{box-shadow:0 0 0 2px #e879f9}
    .modal-backdrop{background:rgba(0,0,0,.6)}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .safe-bottom{padding-bottom:env(safe-area-inset-bottom)}
    .progress-bar{display:flex;gap:.25rem}
    .progress-seg{flex:1;height:3px;background:rgba(255,255,255,.35);border-radius:999px;overflow:hidden}
    .progress-seg>span{display:block;height:100%;width:0;background:white}
  </style>
</head>
<body class="min-h-screen radial-bg text-slate-900">
  <!-- HEADER -->
  <header class="sticky top-0 z-40 border-b border-black/10 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3 min-w-0">
          <div class="h-9 w-9 animate-[spin_9s_linear_infinite] rounded-xl bg-gradient-to-br from-sky-300 via-fuchsia-300 to-amber-300"></div>
          <div class="truncate">
            <div class="text-xs uppercase tracking-widest text-black/60">Moments Hub</div>
            <div class="text-lg font-extrabold leading-5 truncate">Tubonge</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <nav class="hidden sm:flex flex-wrap gap-2">
            <button data-tab="feed" class="tab-btn rounded-full bg-white px-3 py-1 text-xs font-semibold shadow">Feed</button>
            <button data-tab="moments" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">Moments</button>
            <button data-tab="dms" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">DMs</button>
            <button data-tab="account" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">Account</button>
            <button id="adminTabBtn" data-tab="admin" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 hidden">Admin</button>
          </nav>
          <button id="openLoginBtn" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Connect</button>
        </div>
      </div>
    </div>
    <!-- Mobile tabs -->
    <div class="sm:hidden border-t border-black/10 bg-white/90">
      <div id="mobileTabs" class="mx-auto max-w-6xl px-4 py-2 flex gap-2 overflow-x-auto no-scrollbar">
        <button data-tab="feed" class="tab-btn rounded-full bg-white px-3 py-1 text-xs font-semibold shadow whitespace-nowrap">Feed</button>
        <button data-tab="moments" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 whitespace-nowrap">Moments</button>
        <button data-tab="dms" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 whitespace-nowrap">DMs</button>
        <button data-tab="account" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 whitespace-nowrap">Account</button>
        <button id="adminTabBtnMobile" data-tab="admin" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 whitespace-nowrap hidden">Admin</button>
      </div>
    </div>
  </header>

  <!-- STATUS BAR -->
  <div class="bg-amber-50 border-b border-amber-200">
    <div class="mx-auto max-w-6xl px-4 py-2 text-[12px] text-amber-900 flex items-center justify-between gap-3">
      <div id="conn-status" class="truncate">
        Not connected. Tap <strong>Connect</strong> and paste your PAT.
        (Using <code>hunter9201/momentshub-data@main</code>)
      </div>
      <div class="hidden sm:block text-black/60"><em>Token stays in-memory only.</em></div>
    </div>
  </div>

  <main class="mx-auto max-w-6xl px-4 py-6 space-y-8 pb-32 md:pb-8">
    <!-- FEED -->
    <section id="tab-feed" class="space-y-6">
      <div class="flex flex-wrap gap-2 justify-end">
        <button id="openComposeBtn" class="rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs font-semibold shadow-sm">➕ Moment</button>
        <label class="rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs font-semibold shadow-sm cursor-pointer">
          📸 Story
          <input id="story-files" type="file" accept="video/*,image/*" class="hidden" multiple>
        </label>
        <button id="openStudioBtn" class="rounded-full border border-fuchsia-200 bg-white/80 px-4 py-2 text-xs font-semibold shadow-sm">🎬 Studio Pro</button>
      </div>

      <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
        <div class="flex items-center justify-between gap-2">
          <div class="text-xs uppercase tracking-widest text-black/50">Stories (48-hour)</div>
          <div class="chip">Tap to view</div>
        </div>
        <div id="stories-row" class="mt-3 flex gap-3 overflow-x-auto pb-2 no-scrollbar"></div>
      </div>

      <!-- IG-style feed (single column) -->
      <div id="feed" class="grid grid-cols-1 gap-4"></div>
    </section>

    <!-- MOMENTS (vertical viewer) -->
    <section id="tab-moments" class="hidden space-y-4">
      <div class="rounded-2xl border border-black/10 bg-white/80 p-0 card">
        <div class="flex items-center justify-between p-4">
          <div class="text-xs uppercase tracking-widest text-black/50">For You</div>
          <div class="flex items-center gap-2 text-xs"><span class="chip">Scroll / swipe</span><span class="chip">J/K = next/prev</span></div>
        </div>
        <div id="mom-vertical" class="px-3 pb-4 space-y-4" style="scroll-snap-type:y mandatory; max-height: 80svh; overflow:auto;"></div>
      </div>
    </section>

    <!-- DMs -->
    <section id="tab-dms" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">Profiles</div>
          <input id="dm-search" class="mt-2 w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm" placeholder="Search profiles…">
          <div id="dm-people" class="mt-2 max-h-80 overflow-y-auto space-y-1 no-scrollbar"></div>
        </div>
        <div class="md:col-span-2 rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="flex items-center justify-between">
            <div id="dm-header" class="text-xs text-black/60">Pick a person to chat.</div>
            <div class="text-[11px] text-black/50">Tap a bubble to delete your message</div>
          </div>
          <div id="dm-log" class="mt-2 h-72 overflow-y-auto rounded-xl border border-black/5 bg-white/70 p-3 no-scrollbar"></div>
          <div class="mt-2 flex gap-2">
            <input id="dm-msg" class="w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm" placeholder="Type a message…">
            <button id="dm-send" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm font-semibold" disabled>Send</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ACCOUNT -->
    <section id="tab-account" class="hidden space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">App Account</div>
          <div id="appacct-box" class="mt-3 text-sm text-black/70">Not signed in to an app account.</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="openSignInBtn" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Sign in</button>
            <button id="openRegisterBtn" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Register</button>
            <button id="signOutBtn" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm hidden">Sign out</button>
          </div>
        </div>
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card lg:col-span-2">
          <div class="text-xs uppercase tracking-widest text-black/50">Profile</div>
          <div class="mt-3 grid gap-2 text-sm">
            <input id="pf-name" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Display name">
            <input id="pf-handle" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Handle (optional)">
            <button id="pf-save" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Save profile</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">GitHub Identity</div>
          <div id="profile-box" class="mt-3 text-sm">
            <div class="text-black/60">Used to write to the repo.</div>
          </div>
        </div>
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card md:col-span-2">
          <div class="text-xs uppercase tracking-widest text-black/50">Admin Setup</div>
          <div class="mt-3 text-sm">
            <button id="adm-init" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Initialize data folders</button>
            <button id="adm-addme" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Add me as admin</button>
            <div class="text-[11px] text-black/60 mt-2">Creates: <code>profiles/ moments/ stories/ media/ dms/ indexes/ engagement/</code>.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="tab-admin" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">Metrics</div>
          <div id="adm-metrics" class="mt-3 text-sm grid gap-1">
            <div>Total users: …</div>
            <div>Moments: …</div>
            <div>Stories (active): …</div>
          </div>
          <div class="mt-3">
            <button id="btn-rebuild-indexes" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Rebuild indexes</button>
          </div>
        </div>
        <div class="md:col-span-2 rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">Users</div>
          <input id="adm-search" class="mt-3 rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm w-full" placeholder="Search by name/handle/login">
          <div id="adm-users" class="mt-3 text-sm space-y-2 max-h-[26rem] overflow-y-auto no-scrollbar"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MOBILE ACTION BAR -->
  <div id="mobile-actionbar" class="fixed bottom-0 inset-x-0 z-40 md:hidden bg-white/95 backdrop-blur border-t border-black/10 safe-bottom">
    <div class="mx-auto max-w-6xl px-4 py-2 grid grid-cols-3 gap-2">
      <button id="fabCompose" class="rounded-full border border-black/10 bg-white px-3 py-2 text-sm font-semibold shadow-sm">➕ Moment</button>
      <button id="fabStory" class="rounded-full border border-black/10 bg-white px-3 py-2 text-sm font-semibold shadow-sm">📸 Story</button>
      <button id="fabStudio" class="rounded-full border border-fuchsia-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm">🎬 Studio</button>
    </div>
  </div>

  <!-- MODALS -->

  <!-- GitHub PAT only -->
  <div id="modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-md rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Connect to GitHub</h3>
        <button id="closeLoginBtn" class="text-black/50">✕</button>
      </div>
      <div class="mt-3 grid gap-2 text-sm">
        <div class="rounded-xl border border-black/10 bg-white/60 px-3 py-2 text-[12px]">
          Using <code>hunter9201/momentshub-data@main</code>
        </div>
        <input id="gh-token" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="GitHub PAT (contents: read/write)" type="password">
        <button id="gh-connect" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Connect</button>
        <div id="gh-msg" class="text-[11px] text-black/60">Token is only kept in memory for this tab.</div>
      </div>
    </div>
  </div>

  <!-- Compose Moments -->
  <div id="compose-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-xl h-[min(90svh,720px)] overflow-auto rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between sticky top-0 bg-white z-10 pb-2">
        <h3 class="text-sm font-semibold">Create Moments</h3>
        <button id="closeComposeBtn" class="text-black/50">✕</button>
      </div>
      <div class="mt-1 grid gap-2 text-sm">
        <label class="dropzone rounded-xl border border-black/10 bg-white/80 px-3 py-4 shadow-sm cursor-pointer text-center">
          📤 Drop or select files (images/videos)
          <input id="mom-files" type="file" accept="video/*,image/*" class="hidden" multiple>
        </label>
        <input id="mom-caption" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Caption (used for all)" />
        <input id="mom-tags" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="#tags (comma separated)" />
        <input id="mom-link" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Optional link (https://)" />
        <div class="flex items-center justify-between gap-2 sticky bottom-0 bg-white pt-2">
          <div id="mom-progress" class="text-[11px] text-black/60">No files selected.</div>
          <button id="mom-posts" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Post Selected Files</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Moment Viewer -->
  <div id="moment-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-black/10 bg-white p-0 card overflow-hidden">
      <div class="flex items-center justify-between px-4 py-2 border-b border-black/10">
        <div class="flex items-center gap-3" id="moment-author"></div>
        <button id="closeMomentBtn" class="text-black/50 px-2 py-1">✕</button>
      </div>
      <div class="grid grid-cols-1">
        <div class="bg-black/90 text-white p-2" id="moment-media"></div>
        <div class="p-3 space-y-3 max-h-[70svh] overflow-auto">
          <div id="moment-caption" class="text-sm"></div>
          <div class="flex items-center gap-3 text-sm sticky top-0 bg-white pt-2">
            <button id="moment-like-btn" class="rounded-full border border-black/10 bg-white px-3 py-1">❤️ <span id="moment-like-count">0</span></button>
            <div class="text-xs text-black/60"><span id="moment-comment-count">0</span> comments</div>
          </div>
          <div id="moment-comments" class="space-y-2"></div>
          <div class="flex gap-2">
            <input id="moment-comment-input" class="flex-1 rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm" placeholder="Write a comment…">
            <button id="moment-comment-send" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm font-semibold">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stories Viewer -->
  <div id="stories-viewer" class="hidden fixed inset-0 z-50 modal-backdrop">
    <div class="relative w-full h-full">
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="relative w-[min(420px,96vw)] h-[92svh] rounded-2xl overflow-hidden bg-black text-white">
          <div class="absolute top-0 inset-x-0 p-3">
            <div class="progress-bar" id="sv-progress"></div>
            <div class="mt-2 flex items-center justify-between text-sm">
              <div class="flex items-center gap-2" id="sv-header"></div>
              <button id="sv-close" class="text-white/80">✕</button>
            </div>
          </div>
          <div id="sv-media" class="absolute inset-0 grid place-items-center"></div>
          <button id="sv-prev" class="absolute left-0 inset-y-0 w-1/2 opacity-0">prev</button>
          <button id="sv-next" class="absolute right-0 inset-y-0 w-1/2 opacity-0">next</button>
          <div class="absolute bottom-0 inset-x-0 p-3 bg-gradient-to-t from-black/60 to-transparent">
            <div id="sv-caption" class="text-sm"></div>
            <div class="mt-2 flex items-center gap-3 text-sm">
              <button id="sv-like-btn" class="rounded-full bg-white/10 px-3 py-1">❤️ <span id="sv-like-count">0</span></button>
              <span class="text-white/70"><span id="sv-comment-count">0</span> comments</span>
            </div>
            <div class="mt-2 flex gap-2">
              <input id="sv-comment-input" class="flex-1 rounded-xl bg-white/90 text-black px-3 py-2 text-sm" placeholder="Reply…">
              <button id="sv-comment-send" class="rounded-xl bg-white/90 text-black px-3 py-2 text-sm font-semibold">Send</button>
            </div>
            <div id="sv-comments" class="mt-2 space-y-1 max-h-32 overflow-y-auto text-[13px] no-scrollbar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- App Account: Sign In -->
  <div id="signin-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-md rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Sign in (App Account)</h3>
        <button id="closeSigninBtn" class="text-black/50">✕</button>
      </div>
      <div class="mt-3 grid gap-2 text-sm">
        <input id="si-login" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Username (profile login)">
        <input id="si-pin" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" type="password" placeholder="PIN">
        <button id="si-go" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Sign in</button>
      </div>
    </div>
  </div>

  <!-- App Account: Register -->
  <div id="register-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-md rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Register (New App Account)</h3>
        <button id="closeRegisterBtn" class="text-black/50">✕</button>
      </div>
      <div class="mt-3 grid gap-2 text-sm">
        <input id="rg-login" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Username (unique)">
        <input id="rg-name" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Display name">
        <input id="rg-handle" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Handle (optional)">
        <input id="rg-pin" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" type="password" placeholder="PIN (4-8 digits)">
        <button id="rg-go" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Create Account</button>
      </div>
    </div>
  </div>

  <!-- Studio Pro -->
  <div id="studio-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-2xl h-[min(90svh,720px)] overflow-auto rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between sticky top-0 bg-white z-10 pb-2">
        <h3 class="text-sm font-semibold">Studio Pro (Beta)</h3>
        <button id="closeStudioBtn" class="text-black/50">✕</button>
      </div>
      <div class="grid gap-3 text-sm">
        <div class="text-black/70">Batch tools for power users: quick caption presets, tags helper, and bulk posting.</div>
        <label class="dropzone rounded-xl border border-black/10 bg-white/80 px-3 py-4 shadow-sm cursor-pointer text-center">
          🎞️ Select files for a batch
          <input id="studio-files" type="file" accept="video/*,image/*" class="hidden" multiple>
        </label>
        <textarea id="studio-captions" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2 h-28" placeholder="One caption per line (line 1 → file 1, etc.)"></textarea>
        <input id="studio-tags" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="#global, #tags, #for, #all" />
        <div class="flex justify-between items-center">
          <div id="studio-status" class="text-[11px] text-black/60">No batch loaded.</div>
          <button id="studio-run" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Post Batch</button>
        </div>
      </div>
    </div>
  </div>
<script>
// ===== Utilities & State =====
const byId = (id)=>document.getElementById(id);
const modal = byId('modal'), composeModal = byId('compose-modal'),
      momentModal = byId('moment-modal'), storiesViewer = byId('stories-viewer'),
      signinModal = byId('signin-modal'), registerModal = byId('register-modal'),
      studioModal = byId('studio-modal');

const state = {
  owner: 'hunter9201',
  repo: 'momentshub-data',
  branch: 'main',
  token: '',
  me: null,
  isAdmin: false,
  user: null
};

const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
const setStatus = (t, ok=false)=>{ const el = byId('conn-status'); if(el) el.innerHTML = ok? `<span class="text-green-700">${t}</span>`:t; };
const toast = (msg)=>{ const t=document.createElement('div'); t.className='fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] rounded-full bg-black text-white text-xs px-3 py-2 shadow-lg'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2200); };

const switchTab = (t)=>{ ['feed','moments','dms','account','admin'].forEach(k=> byId('tab-'+k).classList.toggle('hidden', k!==t)); updateActiveTabs(t); };
const updateActiveTabs = (active)=> document.querySelectorAll('.tab-btn').forEach(btn=>{
  const on = btn.dataset.tab===active;
  btn.classList.toggle('bg-white', on); btn.classList.toggle('shadow', on); btn.classList.toggle('text-black/70', !on);
});
document.querySelectorAll('.tab-btn').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));
switchTab('feed');

// Buttons
byId('openLoginBtn').onclick=()=>show(modal); byId('closeLoginBtn').onclick=()=>hide(modal);
byId('openComposeBtn').onclick=()=>show(composeModal); byId('closeComposeBtn').onclick=()=>hide(composeModal);
byId('closeMomentBtn').onclick=()=>hide(momentModal);
byId('sv-close').onclick=()=>{ stopStoryTimer(); hide(storiesViewer); };
storiesViewer.addEventListener('click', (e)=>{ if(e.target===storiesViewer){ stopStoryTimer(); hide(storiesViewer);} });
byId('fabCompose').onclick=()=>show(composeModal);
byId('fabStory').onclick=()=> byId('story-files').click();
byId('fabStudio').onclick=()=>show(studioModal);
byId('openStudioBtn').onclick=()=>show(studioModal);
byId('closeStudioBtn').onclick=()=>hide(studioModal);

// ===== GitHub Client (fixed segment encoding) =====
const GH_API='https://api.github.com';
const encodePath = (p)=> p.split('/').map(encodeURIComponent).join('/');
const rawURL=(p)=>`https://raw.githubusercontent.com/${state.owner}/${state.repo}/${state.branch}/${p}`;

async function gh(method, url, body){
  const res = await fetch(url, {method, headers:{
    'Accept':'application/vnd.github+json',
    ...(state.token? {'Authorization':'Bearer '+state.token}:{}) ,'Content-Type':'application/json'
  }, body: body? JSON.stringify(body): undefined});
  if(!res.ok){ const t=await res.text(); throw new Error(`${res.status}: ${t}`); }
  return res.json();
}
async function ghGet(path){
  const url = `${GH_API}/repos/${state.owner}/${state.repo}/contents/${encodePath(path)}?ref=${encodeURIComponent(state.branch)}`;
  return gh('GET', url);
}
async function ghGetSha(path){ try{ const j=await ghGet(path); return j.sha; }catch{return null;} }
async function upsertText(path, text, message){
  const sha = await ghGetSha(path);
  const url = `${GH_API}/repos/${state.owner}/${state.repo}/contents/${encodePath(path)}`;
  return gh('PUT', url, {
    message: message || `update ${path}`,
    content: btoa(unescape(encodeURIComponent(text))),
    branch: state.branch,
    ...(sha?{sha}:{})
  });
}
async function upsertBinary(path,file,message){
  const buf=await file.arrayBuffer(); const bytes=new Uint8Array(buf); let binary='';
  for(let i=0;i<bytes.length;i+=0x8000){ binary+=String.fromCharCode.apply(null, bytes.subarray(i,i+0x8000)); }
  const content=btoa(binary);
  const sha=await ghGetSha(path);
  const url = `${GH_API}/repos/${state.owner}/${state.repo}/contents/${encodePath(path)}`;
  return gh('PUT', url, { message: message||`upload ${path}`, content, branch: state.branch, ...(sha?{sha}:{}) });
}
async function ensureDirs(){ const mk=async p=>{ try{ await upsertText(`${p}/.gitkeep`, '', `init ${p}`);}catch{} };
  await mk('profiles'); await mk('moments'); await mk('stories'); await mk('media'); await mk('dms'); await mk('indexes'); await mk('engagement/moments'); await mk('engagement/stories');
}

// ===== Connect (PAT only, defaults for owner/repo/branch) =====
byId('gh-connect').onclick = async ()=>{
  state.token = byId('gh-token').value.trim();
  const msg=byId('gh-msg');
  try{
    const ures=await fetch(`${GH_API}/user`,{headers: state.token? {Authorization:'Bearer '+state.token}:{}}); if(!ures.ok) throw new Error('Invalid token or network');
    const me=await ures.json(); state.me=me;
    setStatus(`Connected as <strong>@${me.login}</strong>. Repo: <code>${state.owner}/${state.repo}@${state.branch}</code>`, true);
    msg.textContent='Connected ✓'; hide(modal);
    await ensureDirs(); await ensureProfile(me.login); await loadAdminStatus();
    await Promise.all([loadFeed(), loadStories(), loadVertical(), loadPeople(), renderProfileBox(), renderAdmin(), restoreAppUser()]);
    toast('Connected to GitHub');
  }catch(err){ msg.textContent=err.message; setStatus('Not connected. Check your token.'); }
};

async function ensureProfile(login){
  const p=`profiles/${login}.json`; let cur=null; try{ cur=await (await fetch(rawURL(p))).json(); }catch{}
  if(!cur || !cur.login){ const data={ login, name: state.me?.name || login, handle:null, role:'user', status:'active', created_at:new Date().toISOString() }; await upsertText(p, JSON.stringify(data,null,2), `create profile ${login}`); }
}
async function loadAdminStatus(){
  try{ const admins=await (await fetch(rawURL('admins.json'))).json();
    state.isAdmin=Array.isArray(admins)&&admins.includes(state.me?.login);
    byId('adminTabBtn').classList.toggle('hidden', !state.isAdmin);
    byId('adminTabBtnMobile').classList.toggle('hidden', !state.isAdmin);
  }catch{ byId('adminTabBtn').classList.add('hidden'); byId('adminTabBtnMobile').classList.add('hidden'); state.isAdmin=false; }
}
async function renderProfileBox(){
  const box=byId('profile-box'); if(!state.me){ box.innerHTML=`<div class="text-black/60">Not connected.</div>`; return; }
  const ppath=`profiles/${state.me.login}.json`; let prof=null; try{ prof=await (await fetch(rawURL(ppath))).json(); }catch{}
  box.innerHTML=`<div class="flex items-center gap-3">
    <div class="h-12 w-12 rounded-full border border-black/10 bg-white/70 grid place-items-center text-xs">${(prof?.name||state.me.login).slice(0,1)}</div>
    <div><div class="font-semibold">${prof?.name||state.me.login} <span class="chip">${prof?.role||'user'}</span></div>
    <div class="text-xs text-black/60">@${state.me.login} ${prof?.handle? '• @'+prof.handle:''}</div></div></div>`;
}

// ===== Engagement storage =====
const ENG = { moments: id=>`engagement/moments/${id}.json`, stories: id=>`engagement/stories/${id}.json` };
async function ensureEngagement(kind,id){ const path=ENG[kind](id); try{ await (await fetch(rawURL(path),{cache:'no-store'})).json(); }catch{ await upsertText(path, JSON.stringify({likes:[],comments:[]},null,2), `init engagement ${kind}/${id}`); } }
async function readEngagement(kind,id){ const path=ENG[kind](id); try{ return await (await fetch(rawURL(path),{cache:'no-store'})).json(); }catch{ return {likes:[],comments:[]}; } }
async function writeEngagement(kind,id,data){ const path=ENG[kind](id); await upsertText(path, JSON.stringify(data,null,2), `engage ${kind}/${id}`); }
async function toggleLike(kind,id){ if(!currentLogin()) return alert('Sign in to an app account first'); await ensureEngagement(kind,id); const data=await readEngagement(kind,id); const who=currentLogin(); const i=(data.likes||[]).indexOf(who); if(i>=0) data.likes.splice(i,1); else data.likes.push(who); await writeEngagement(kind,id,data); return data; }
async function addComment(kind,id,text){ if(!currentLogin()) return alert('Sign in to an app account first'); await ensureEngagement(kind,id); const data=await readEngagement(kind,id); data.comments=data.comments||[]; data.comments.push({id:`${Date.now()}_${Math.random().toString(36).slice(2)}`,from:currentLogin(),text,ts:Date.now()}); await writeEngagement(kind,id,data); }
function renderComments(list){ return (list||[]).slice(-150).map(c=>`<div class="rounded-xl bg-black/5 p-2"><div class="text-[11px] text-black/60">@${c.from} • ${new Date(c.ts).toLocaleString()}</div><div class="text-sm">${c.text}</div></div>`).join(''); }
async function refreshEngagementUI(kind,id,{likeCountEl, commentCountEl, commentsHost}){ const data=await readEngagement(kind,id); if(likeCountEl) likeCountEl.textContent=data.likes?.length||0; if(commentCountEl) commentCountEl.textContent=data.comments?.length||0; if(commentsHost) commentsHost.innerHTML=renderComments(data.comments); }

// ===== Moments (IG-style) =====
function cardHTML(m, author){
  const media = m.kind==='video'
    ? `<video class="w-full aspect-[4/5] object-cover rounded-xl" src="${m.media_url}" muted playsinline loop></video>`
    : `<img class="w-full aspect-[4/5] object-cover rounded-xl" src="${m.media_url}" alt="">`;
  return `
  <article class="rounded-2xl border bg-white shadow p-3" data-moment="${m.id}">
    <header class="flex items-center justify-between mb-2">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-full bg-black/10 grid place-items-center text-xs">${(author?.name||m.author||'—').slice(0,1)}</div>
        <div class="text-sm font-semibold">${author?.name||m.author}</div>
      </div>
      ${m.link ? `<a href="${m.link}" target="_blank" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">🔗</a>` : ``}
    </header>
    <div class="mb-2">${media}</div>
    <div class="flex items-center gap-3 text-sm mb-2">
      <button class="rounded-full border border-black/10 bg-white/80 px-3 py-1" data-like-moment="${m.id}">❤️ <span class="like-count">0</span></button>
      <button class="rounded-full border border-black/10 bg-white/80 px-3 py-1" data-view="${m.id}">💬 <span class="comment-count">0</span></button>
    </div>
    <div class="text-sm"><span class="font-semibold">${author?.name||m.author}</span> ${m.caption||''}</div>
    ${ (m.tags?.length? `<div class="mt-1 text-xs text-black/60">${m.tags.map(t=>'#'+t).join(' ')}</div>`:'') }
  </article>`;
}

async function uploadMedia(file){
  if(!state.me) throw new Error('Connect to GitHub first');
  const ext=(file.name.split('.').pop()||'bin').toLowerCase();
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const d=new Date(); const year=d.getUTCFullYear(); const month=String(d.getUTCMonth()+1).padStart(2,'0');
  const path=`media/${year}/${month}/${currentLogin()||state.me.login}_${id}.${ext}`;
  await upsertBinary(path,file,`upload media ${id}`); return rawURL(path);
}
async function postOneMomentFromFile(file, common){
  if(!currentLogin()) throw new Error('Sign in to an app account first');
  const kind=(file.type||'').startsWith('video')?'video':'image';
  const media_url=await uploadMedia(file);
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const meta={ id, author: currentLogin(), kind, caption: common.caption, tags: common.tags, link: common.link, media_url, created_at:new Date().toISOString() };
  await upsertText(`moments/${id}.json`, JSON.stringify(meta,null,2), `post moment ${id}`);
  await ensureEngagement('moments', id);
  return meta;
}
function parseTags(v){ return (v||'').split(',').map(s=>s.trim().replace(/^#/,'')).filter(Boolean); }
function limitConcurrency(items,limit,worker){ return new Promise((resolve,reject)=>{ let i=0,active=0,results=[]; const run=()=>{ while(active<limit && i<items.length){ const cur=items[i]; const idx=i; i++; active++; Promise.resolve(worker(cur,idx)).then(r=>results[idx]=r).catch(reject).finally(()=>{ active--; if(i>=items.length&&active===0) resolve(results); else run(); }); } }; run(); }); }

byId('mom-posts').onclick = async ()=>{
  try{
    const files=byId('mom-files').files; if(!files?.length) return alert('Select files first');
    const caption=byId('mom-caption').value.trim(); const tags=parseTags(byId('mom-tags').value); const link=byId('mom-link').value.trim()||null;
    const total=files.length; let done=0; const prog=byId('mom-progress'); prog.textContent=`Uploading 0/${total}…`;
    await limitConcurrency(Array.from(files),3, async f=>{ const m=await postOneMomentFromFile(f,{caption,tags,link}); done++; prog.textContent=`Uploaded ${done}/${total}`; await prependToIndex(m); });
    prog.textContent='Done ✓'; byId('mom-files').value=''; byId('mom-caption').value=''; byId('mom-tags').value=''; byId('mom-link').value='';
    await loadFeed(); await loadVertical(); hide(composeModal); toast('Moments posted');
  }catch(err){ alert(err.message); }
};

// ===== Stories (48h) + Viewer =====
function storyChipHTML(user,firstStory,name){
  const media = firstStory.kind==='image'
    ? `<img src="${firstStory.media_url}" class="h-full w-full object-cover">`
    : `<video src="${firstStory.media_url}" class="h-full w-full object-cover" muted></video>`;
  return `<button class="flex flex-col items-center gap-1" data-story-author="${user}">
    <span class="block h-16 w-16 rounded-full story-ring overflow-hidden">${media}</span>
    <span class="text-[11px] max-w-24 truncate">${name||user}</span>
  </button>`;
}
async function postOneStoryFromFile(file){
  if(!currentLogin()) throw new Error('Sign in to an app account first');
  const kind=(file.type||'').startsWith('video')?'video':'image';
  const media_url=await uploadMedia(file);
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const created_at=new Date().toISOString(); const expires_at=new Date(Date.now()+48*3600*1000).toISOString();
  const s={ id, author: currentLogin(), kind, caption:'', media_url, created_at, expires_at };
  await upsertText(`stories/${id}.json`, JSON.stringify(s,null,2), `add story ${id}`); await ensureEngagement('stories',id); return s;
}
byId('story-files').onchange = async (e)=>{
  try{ const files=Array.from(e.target.files||[]); if(!files.length) return;
    toast(`Adding ${files.length} stor${files.length>1?'ies':'y'}…`);
    await limitConcurrency(files,3, postOneStoryFromFile); e.target.value=''; await loadStories(); toast('Stories added');
  }catch(err){ alert(err.message); }
};

async function listJsonIn(path){
  let items=[]; try{ const arr=await ghGet(path); items=Array.isArray(arr)? arr.filter(x=>x.type==='file' && x.name.endsWith('.json')):[]; }catch{}
  const out=[]; for(const it of items){ try{ const j=await (await fetch(it.download_url,{cache:'no-store'})).json(); out.push(j);}catch{} } return out;
}

let STORY_GROUPS=[]; // [{author,name,stories:[]}]
async function loadStories(){
  const row=byId('stories-row'); row.innerHTML='';
  const stories=await listJsonIn('stories'); const now=Date.now();
  const live=stories.filter(s=> new Date(s.expires_at).getTime() > now).sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
  const byAuthor=new Map();
  for(const s of live){ if(!byAuthor.has(s.author)) byAuthor.set(s.author,[]); byAuthor.get(s.author).push(s); }
  STORY_GROUPS=[]; for(const [author,arr] of byAuthor.entries()){ let prof=null; try{ prof=await (await fetch(rawURL(`profiles/${author}.json`))).json(); }catch{} STORY_GROUPS.push({author, name:prof?.name||author, stories:arr}); }
  if(!STORY_GROUPS.length){ row.innerHTML=`<div class="text-sm text-black/60">No active stories.</div>`; return; }
  row.innerHTML = STORY_GROUPS.map(g=> storyChipHTML(g.author, g.stories[g.stories.length-1], g.name)).join('');
}

// Viewer
let svGroup=0, svIdx=0, svTimer=null, svVideo=null;
const IMG_DURATION=6000;
function stopStoryTimer(){ if(svTimer){ clearTimeout(svTimer); svTimer=null; } if(svVideo){ try{svVideo.pause();}catch{} svVideo=null; } }
function startStoryTimer(ms){ stopStoryTimer(); svTimer=setTimeout(()=> nextStory(), ms); animateProgress(ms); }
function animateProgress(ms){ const segs=byId('sv-progress').querySelectorAll('.progress-seg>span'); const cur=segs[svIdx]; if(cur){ cur.style.transition=`width ${ms}ms linear`; requestAnimationFrame(()=> cur.style.width='100%'); } }
function renderStory(){
  const g=STORY_GROUPS[svGroup]; if(!g) return hide(storiesViewer);
  const s=g.stories[svIdx]; if(!s) return hide(storiesViewer);
  byId('sv-header').innerHTML=`<div class="h-8 w-8 rounded-full bg-white/20 grid place-items-center text-xs">${g.name.slice(0,1)}</div><div>${g.name} <span class="text-white/60 text-xs">@${g.author}</span></div>`;
  byId('sv-progress').innerHTML = g.stories.map((_,i)=>`<div class="progress-seg"><span style="width:${i<svIdx?'100%':'0'}"></span></div>`).join('');
  const mediaHost=byId('sv-media'); mediaHost.innerHTML=''; const isVid=s.kind==='video';
  if(isVid){ const v=document.createElement('video'); v.src=s.media_url; v.playsInline=true; v.muted=true; v.autoplay=true; v.className='max-h-full max-w-full'; mediaHost.appendChild(v); svVideo=v; v.onloadedmetadata=()=>{ startStoryTimer(v.duration? v.duration*1000: IMG_DURATION); v.play().catch(()=>{}); }; v.onended=()=> nextStory(); }
  else { const img=document.createElement('img'); img.src=s.media_url; img.className='max-h-full max-w-full object-contain'; mediaHost.appendChild(img); startStoryTimer(IMG_DURATION); }
  byId('sv-caption').textContent=s.caption||'';
  refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') });
  byId('sv-like-btn').onclick=async ()=>{ await toggleLike('stories', s.id); refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') }); };
  byId('sv-comment-send').onclick=async ()=>{ const input=byId('sv-comment-input'); const text=(input.value||'').trim(); if(!text) return; await addComment('stories', s.id, text); input.value=''; refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') }); };
}
function nextStory(){ const g=STORY_GROUPS[svGroup]; if(svIdx<g.stories.length-1){ svIdx++; renderStory(); } else if(svGroup<STORY_GROUPS.length-1){ svGroup++; svIdx=0; renderStory(); } else { hide(storiesViewer); stopStoryTimer(); } }
function prevStory(){ if(svIdx>0){ svIdx--; renderStory(); } else if(svGroup>0){ svGroup--; svIdx=STORY_GROUPS[svGroup].stories.length-1; renderStory(); } }
byId('sv-next').onclick=nextStory; byId('sv-prev').onclick=prevStory;
byId('stories-row').addEventListener('click', (e)=>{ const btn=e.target.closest('[data-story-author]'); if(!btn) return; const author=btn.getAttribute('data-story-author'); svGroup=STORY_GROUPS.findIndex(g=>g.author===author); svIdx=0; show(storiesViewer); renderStory(); });

// ===== Feed & Vertical (index + pagination) =====
const IDX={ moments:'indexes/moments.json' }; let momentsIndex=null, feedCursor=0, vertCursor=0;
const PAGE_SIZE=10, VERT_PAGE=5;

async function readRaw(path){ try{ return await (await fetch(rawURL(path),{cache:'no-store'})).json(); }catch{ return null; } }
async function writeIndex(path,data,msg){ await upsertText(path, JSON.stringify(data,null,2), msg||'update index'); }

async function loadMomentsIndex({force=false}={}){
  if(!force){ if(momentsIndex) return momentsIndex; const cached=sessionStorage.getItem('mh:index:moments'); if(cached){ try{ momentsIndex=JSON.parse(cached); return momentsIndex;}catch{} } }
  let idx=await readRaw(IDX.moments);
  if(!idx){
    let arr=[]; try{ arr=await ghGet('moments'); }catch{}
    idx=[]; for(const it of (arr||[])){ if(it.type==='file' && it.name.endsWith('.json')){ try{ const j=await (await fetch(it.download_url,{cache:'no-store'})).json(); idx.push({ id:j.id, author:j.author, created_at:j.created_at, caption:j.caption||'', tags:j.tags||[], link:j.link||null, media_url:j.media_url, kind:j.kind||'image' }); }catch{} } }
    try{ await writeIndex(IDX.moments, idx, 'build moments index'); }catch{}
  }
  idx.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  momentsIndex=idx; try{ sessionStorage.setItem('mh:index:moments', JSON.stringify(idx)); }catch{} return idx;
}
async function prependToIndex(meta){
  let idx=await loadMomentsIndex({force:true}) || []; idx.unshift({ id:meta.id, author:meta.author, kind:meta.kind, caption:meta.caption||'', tags:meta.tags||[], link:meta.link||null, media_url:meta.media_url, created_at:meta.created_at});
  try{ await writeIndex(IDX.moments, JSON.stringify(idx), 'append moments index'); }catch{} sessionStorage.removeItem('mh:index:moments');
}

async function renderFeedPage(reset=false){
  const host=byId('feed'); if(reset){ feedCursor=0; host.innerHTML=''; }
  const idx=await loadMomentsIndex({force:false}); const slice=idx.slice(feedCursor, feedCursor+PAGE_SIZE);
  if(slice.length===0 && feedCursor===0){ host.innerHTML=`<div class="text-sm text-black/60">No posts yet.</div>`; return; }
  const authorMap=new Map();
  for(const m of slice){
    if(!authorMap.has(m.author)){ try{ const p=await (await fetch(rawURL(`profiles/${m.author}.json`))).json(); authorMap.set(m.author,p); }catch{ authorMap.set(m.author,null); } }
    const wrap=document.createElement('div'); wrap.innerHTML=cardHTML(m, authorMap.get(m.author));
    const el=wrap.firstElementChild; host.appendChild(el);
    refreshEngagementUI('moments', m.id, { likeCountEl: el.querySelector('.like-count'), commentCountEl: el.querySelector('.comment-count') });
  }
  feedCursor += slice.length;
  let moreBtn=document.getElementById('feed-more');
  if(feedCursor < idx.length){ if(!moreBtn){ moreBtn=document.createElement('button'); moreBtn.id='feed-more'; moreBtn.className='w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm shadow-sm'; moreBtn.textContent='Load more'; moreBtn.onclick=()=>renderFeedPage(false); host.parentElement.appendChild(moreBtn);} }
  else if(moreBtn){ moreBtn.remove(); }
}
async function loadFeed(){ await renderFeedPage(true); }

function verticalItemHTML(m, author){
  return `<div class="rounded-2xl overflow-hidden border border-black/10 bg-black/90 text-white relative" style="scroll-snap-align:center">
    <div class="aspect-[9/16] w-full relative">
      ${m.kind==='video' ? `<video class="vitem absolute inset-0 h-full w-full object-cover" src="${m.media_url}" playsinline muted loop></video>` : `<img class="absolute inset-0 h-full w-full object-cover" src="${m.media_url}" alt="">`}
      <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/70 to-black/0">
        <div class="text-sm font-semibold truncate">${author?.name||m.author}</div>
        <div class="text-sm opacity-90 truncate">${m.caption||''}</div>
        <div class="text-xs opacity-70 truncate">${(m.tags||[]).map(t=>'#'+t).join(' ')}</div>
      </div>
    </div>
  </div>`;
}
async function renderVerticalPage(reset=false){
  const host=byId('mom-vertical'); if(reset){ vertCursor=0; host.innerHTML=''; }
  const idx=await loadMomentsIndex({force:false}); const chunk=idx.slice(vertCursor, vertCursor+VERT_PAGE);
  const authorMap=new Map();
  for(const m of chunk){
    if(!authorMap.has(m.author)){ try{ const p=await (await fetch(rawURL(`profiles/${m.author}.json`))).json(); authorMap.set(m.author,p);}catch{ authorMap.set(m.author,null);} }
    host.insertAdjacentHTML('beforeend', verticalItemHTML(m, authorMap.get(m.author)));
  }
  vertCursor += chunk.length;
  const vids=[...host.querySelectorAll('.vitem')];
  if('IntersectionObserver' in window){
    const obs=new IntersectionObserver((entries)=> entries.forEach(en=>{ const v=en.target; if(en.isIntersecting && en.intersectionRatio>0.6){ v.play().catch(()=>{}); } else { v.pause(); } }), {threshold:[0,0.6,1]});
    vids.forEach(v=>obs.observe(v));
  } else vids.forEach(v=> v.play && v.play().catch(()=>{}));
}
async function loadVertical(){ await renderVerticalPage(true); }
(function(){ const host=byId('mom-vertical'); host.addEventListener('scroll', ()=>{ if(host.scrollTop + host.clientHeight >= host.scrollHeight - 200){ renderVerticalPage(false); } }); document.addEventListener('keydown',(e)=>{ if(byId('tab-moments').classList.contains('hidden')) return; if(e.key.toLowerCase()==='j') host.scrollBy({top:host.clientHeight*0.9, behavior:'smooth'}); if(e.key.toLowerCase()==='k') host.scrollBy({top:-host.clientHeight*0.9, behavior:'smooth'}); }); })();

// Feed actions
byId('feed').addEventListener('click', async (e)=>{
  const likeBtn=e.target.closest('[data-like-moment]'); if(likeBtn){ const id=likeBtn.getAttribute('data-like-moment'); await toggleLike('moments', id); await refreshEngagementUI('moments', id, { likeCountEl: likeBtn.querySelector('.like-count'), commentCountEl: likeBtn.parentElement.querySelector('.comment-count') }); return; }
  const viewBtn=e.target.closest('[data-view]'); if(viewBtn){ openMomentViewer(viewBtn.getAttribute('data-view')); }
});
async function openMomentViewer(id){
  const idx=await loadMomentsIndex({force:false}); const m=idx.find(x=>x.id===id); if(!m) return alert('Moment not found');
  let prof=null; try{ prof=await (await fetch(rawURL(`profiles/${m.author}.json`))).json(); }catch{}
  byId('moment-author').innerHTML=`<div class="h-8 w-8 rounded-full bg-black/10 grid place-items-center text-xs">${(prof?.name||m.author).slice(0,1)}</div><div><div class="text-sm font-semibold">${prof?.name||m.author}</div><div class="text-[11px] text-black/60">@${m.author}</div></div>`;
  byId('moment-media').innerHTML = m.kind==='video' ? `<video src="${m.media_url}" class="max-h-[65svh] w-full object-contain" controls playsinline></video>` : `<img src="${m.media_url}" class="max-h-[65svh] w-full object-contain" />`;
  byId('moment-caption').textContent=m.caption||'';
  await ensureEngagement('moments', id);
  await refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') });
  byId('moment-like-btn').onclick=async ()=>{ await toggleLike('moments', id); refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') }); };
  byId('moment-comment-send').onclick=async ()=>{ const i=byId('moment-comment-input'); const text=(i.value||'').trim(); if(!text) return; await addComment('moments', id, text); i.value=''; refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') }); };
  show(momentModal);
}

// ===== Auto Refresh every 4 seconds (soft) =====
setInterval(async ()=>{
  // Only when connected (token present) — keep session alive, no logout
  if(!state.token) return;
  try{
    // Refresh stories always (cheap)
    loadStories();
    // If feed tab visible, refresh feed top page
    if(!byId('tab-feed').classList.contains('hidden')) await loadFeed();
    // If moments tab visible, refresh vertical page
    if(!byId('tab-moments').classList.contains('hidden')) await loadVertical();
    // If DMs active and a thread open, refresh it
    if(!byId('tab-dms').classList.contains('hidden')) { if(typeof renderDM==='function') renderDM(); }
    // Refresh admin metrics quietly if admin tab open
    if(!byId('tab-admin').classList.contains('hidden')) { if(typeof renderAdmin==='function') renderAdmin(); }
  }catch(e){ /* ignore transient errors */ }
}, 4000);
</script>
<script>
// ===== App Accounts (multi-user like IG) =====
const currentLogin = () => state.user?.login || null;

function appBoxRender(){
  const box=byId('appacct-box'); const outBtn=byId('signOutBtn');
  if(state.user){
    box.innerHTML=`Signed in as <strong>@${state.user.login}</strong> (<span class="text-black/70">${state.user.name||state.user.login}</span>)`;
    outBtn.classList.remove('hidden');
  } else {
    box.textContent='Not signed in to an app account.'; outBtn.classList.add('hidden');
  }
  byId('pf-name').value = state.user?.name || '';
  byId('pf-handle').value = state.user?.handle || '';
}

async function restoreAppUser(){
  const saved = sessionStorage.getItem('mh:appUser');
  if(saved){ try{ const p=await (await fetch(rawURL(`profiles/${saved}.json`),{cache:'no-store'})).json(); state.user=p; }catch{} }
  appBoxRender();
}

async function sha256Hex(s){
  if(window.crypto?.subtle){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(s)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } return String(h);
}

byId('openSignInBtn').onclick=()=>show(signinModal);
byId('closeSigninBtn').onclick=()=>hide(signinModal);
byId('openRegisterBtn').onclick=()=>show(registerModal);
byId('closeRegisterBtn').onclick=()=>hide(registerModal);
byId('signOutBtn').onclick=()=>{ state.user=null; sessionStorage.removeItem('mh:appUser'); appBoxRender(); toast('Signed out'); };

byId('rg-go').onclick = async ()=>{
  try{
    if(!state.me) return alert('Connect to GitHub first');
    const login=byId('rg-login').value.trim(); const name=byId('rg-name').value.trim()||login; const handle=(byId('rg-handle').value.trim()||null); const pin=byId('rg-pin').value.trim();
    if(!login || !pin) return alert('Username & PIN required');
    let exists=true; try{ await (await fetch(rawURL(`profiles/${login}.json`),{cache:'no-store'})).json(); }catch{ exists=false; }
    if(exists) return alert('Username already exists');
    const pin_hash=await sha256Hex(pin);
    const prof={ login, name, handle, role:'user', status:'active', created_at:new Date().toISOString(), auth:{pin_hash} };
    await upsertText(`profiles/${login}.json`, JSON.stringify(prof,null,2), `register profile ${login}`);
    state.user=prof; sessionStorage.setItem('mh:appUser', login); appBoxRender(); hide(registerModal); toast('Account created & signed in');
    await loadPeople();
  }catch(err){ alert(err.message); }
};

byId('si-go').onclick = async ()=>{
  try{
    if(!state.me) return alert('Connect to GitHub first');
    const login=byId('si-login').value.trim(); const pin=byId('si-pin').value.trim(); if(!login||!pin) return;
    let prof=null; try{ prof=await (await fetch(rawURL(`profiles/${login}.json`),{cache:'no-store'})).json(); }catch{ }
    if(!prof?.auth?.pin_hash) return alert('Account not found or no PIN set');
    const pin_hash=await sha256Hex(pin); if(pin_hash!==prof.auth.pin_hash) return alert('Invalid PIN');
    state.user=prof; sessionStorage.setItem('mh:appUser', login); appBoxRender(); hide(signinModal); toast('Signed in');
    await loadPeople();
  }catch(err){ alert(err.message); }
};

// Save profile edits for current app user
byId('pf-save').onclick = async ()=>{
  try{
    if(!state.user) return alert('Sign in to an app account first');
    const p=`profiles/${state.user.login}.json`; let prof=null; try{ prof=await (await fetch(rawURL(p),{cache:'no-store'})).json(); }catch{}
    prof=prof||{login:state.user.login, role:'user', status:'active', created_at:new Date().toISOString()};
    prof.name = byId('pf-name').value.trim() || prof.name || state.user.login;
    prof.handle = byId('pf-handle').value.trim() || null;
    await upsertText(p, JSON.stringify(prof,null,2), `update profile ${state.user.login}`);
    state.user=prof; appBoxRender(); toast('Profile saved');
    await loadPeople();
  }catch(err){ alert(err.message); }
};

// ===== DMs (show all profiles, delete own messages) =====
let DM_OTHER=null;
const pairKey=(a,b)=> [a,b].sort().join('__');

async function loadPeople(){
  let list=[]; try{ const arr=await ghGet('profiles'); for(const it of arr){ if(it.type==='file' && it.name.endsWith('.json')){ try{ const p=await (await fetch(it.download_url,{cache:'no-store'})).json(); list.push(p);}catch{} } } }catch{}
  const q=(byId('dm-search').value||'').toLowerCase();
  list=list.filter(p=> [p.name,p.handle,p.login].join(' ').toLowerCase().includes(q));
  const host=byId('dm-people'); host.innerHTML='';
  list.forEach(u=>{
    const row=document.createElement('button'); row.className='w-full text-left rounded-xl border border-black/10 bg-white/70 px-3 py-2 shadow-sm flex items-center gap-2';
    row.innerHTML=`<div class="h-8 w-8 rounded-full border border-black/10 grid place-items-center text-[11px]">${(u.name||u.login).slice(0,1)}</div>
      <div><div class="font-semibold">${u.name||'—'} ${u.handle? '• @'+u.handle:''}</div>
      <div class="text-[11px] text-black/60">@${u.login}</div></div>`;
    row.onclick=()=>{ DM_OTHER=u; renderDM(); };
    host.appendChild(row);
  });
}
byId('dm-search').addEventListener('input', loadPeople);

async function readThread(a,b){ const key=pairKey(a,b); const path=`dms/${key}.json`; try{ return await (await fetch(rawURL(path),{cache:'no-store'})).json(); }catch{ return {key, messages:[]}; } }
async function writeThread(a,b,thread){ const key=pairKey(a,b); const path=`dms/${key}.json`; await upsertText(path, JSON.stringify(thread,null,2), `dm ${key}`); }

async function renderDM(){
  const me = currentLogin(); const hdr=byId('dm-header'); const log=byId('dm-log'); const send=byId('dm-send');
  if(!me || !DM_OTHER){ hdr.textContent='Pick a person to chat.'; log.innerHTML=''; send.disabled=true; return; }
  hdr.textContent=`Chatting with ${DM_OTHER.name||'—'} (@${DM_OTHER.handle||DM_OTHER.login})`;
  send.disabled=false;
  const thread=await readThread(me, DM_OTHER.login);
  log.innerHTML = (thread.messages||[]).map(m=>{
    const mine = m.from===me;
    const cls = mine? 'text-right':'';
    return `<div class="mb-2 ${cls}">
      <button class="inline-block rounded-xl px-3 py-2 text-sm ${mine?'bg-sky-100':'bg-white/70'}" data-delmsg="${m.id}">${m.text}</button>
      <div class="text-[10px] text-black/50">${new Date(m.ts).toLocaleString()} • ${m.from}</div>
    </div>`;
  }).join('');
  log.scrollTop=log.scrollHeight;

  log.onclick = async (e)=>{
    const btn=e.target.closest('[data-delmsg]'); if(!btn) return;
    const id=btn.getAttribute('data-delmsg');
    const mine = btn.parentElement.classList.contains('text-right');
    if(!mine && !state.isAdmin) return; // only own or admin
    const t=await readThread(me, DM_OTHER.login);
    t.messages=(t.messages||[]).filter(x=>x.id!==id);
    await writeThread(me, DM_OTHER.login, t);
    await renderDM();
  };
}

byId('dm-send').onclick = async ()=>{
  const me=currentLogin(); if(!me || !DM_OTHER) return alert('Sign into an app account and pick someone');
  const input=byId('dm-msg'); const text=(input.value||'').trim(); if(!text) return;
  const thread=await readThread(me, DM_OTHER.login); thread.messages=thread.messages||[];
  thread.messages.push({ id:`${Date.now()}_${Math.random().toString(36).slice(2)}`, from: me, to: DM_OTHER.login, text, ts: Date.now() });
  await writeThread(me, DM_OTHER.login, thread); input.value=''; await renderDM();
};

// ===== Admin helpers =====
byId('adm-init').onclick = async ()=>{ if(!state.me) return alert('Connect first'); await ensureDirs(); toast('Initialized folders'); };
byId('adm-addme').onclick = async ()=>{ if(!state.me) return alert('Connect first'); let arr=[]; try{ arr=await (await fetch(rawURL('admins.json'))).json(); }catch{} if(!Array.isArray(arr)) arr=[]; if(!arr.includes(state.me.login)) arr.push(state.me.login); await upsertText('admins.json', JSON.stringify(arr,null,2), 'update admins'); await loadAdminStatus(); toast('You are admin now'); };

async function renderAdmin(){
  const showBtn=(id,showit)=> byId(id).classList.toggle('hidden', !showit);
  showBtn('adminTabBtn', state.isAdmin); showBtn('adminTabBtnMobile', state.isAdmin);
  if(!state.isAdmin) return;
  let users=[]; try{ const arr=await ghGet('profiles'); for(const it of arr){ if(it.type==='file' && it.name.endsWith('.json')){ try{ users.push(await (await fetch(it.download_url,{cache:'no-store'})).json()); }catch{} } } }catch{}
  let moments=0; try{ const arr=await ghGet('moments'); moments=Array.isArray(arr)? arr.length:0; }catch{}
  let stories=0; try{ const arr=await ghGet('stories'); const now=Date.now(); for(const it of arr){ if(it.type==='file' && it.name.endsWith('.json')){ try{ const s=await (await fetch(it.download_url,{cache:'no-store'})).json(); if(new Date(s.expires_at).getTime()>now) stories++; }catch{} } } }catch{}
  byId('adm-metrics').innerHTML=`<div>Total users: ${users.length}</div><div>Moments: ${moments}</div><div>Stories (active): ${stories}</div>`;
  const q=(byId('adm-search').value||'').toLowerCase(); const host=byId('adm-users'); host.innerHTML='';
  users.filter(u=>[u.name,u.handle,u.login].join(' ').toLowerCase().includes(q)).forEach(u=>{
    const row=document.createElement('div'); row.className='rounded-xl border border-black/10 bg-white/70 p-3 shadow-sm flex items-center justify-between';
    row.innerHTML=`<div><div class="font-semibold">${u.name||'—'} ${u.handle? '• @'+u.handle:''}</div><div class="text-xs text-black/60">@${u.login} • ${u.role||'user'} • ${u.status||'active'}</div></div>
      <div class="flex gap-2"><button class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-[11px]" data-act="role" data-id="${u.login}">${u.role==='admin'?'Demote':'Promote'}</button>
      <button class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-[11px]" data-act="suspend" data-id="${u.login}">${u.status==='suspended'?'Unsuspend':'Suspend'}</button></div>`;
    host.appendChild(row);
  });
  host.onclick = async (e)=>{ const btn=e.target.closest('[data-act]'); if(!btn) return; const login=btn.dataset.id; const act=btn.dataset.act; const p=`profiles/${login}.json`; let prof=null; try{ prof=await (await fetch(rawURL(p),{cache:'no-store'})).json(); }catch{} if(!prof) return alert('Profile missing'); if(act==='role') prof.role=(prof.role==='admin'?'user':'admin'); if(act==='suspend') prof.status=(prof.status==='suspended'?'active':'suspended'); await upsertText(p, JSON.stringify(prof,null,2), `admin update ${login}`); await renderAdmin(); };
  byId('adm-search').oninput=renderAdmin;
}
byId('btn-rebuild-indexes').onclick = async ()=>{ if(!state.isAdmin) return alert('Admins only');
  let idx=[]; try{ const arr=await ghGet('moments'); for(const it of (arr||[])){ if(it.type==='file' && it.name.endsWith('.json')){ try{ const j=await (await fetch(it.download_url,{cache:'no-store'})).json(); idx.push({ id:j.id, author:j.author, kind:j.kind||'image', caption:j.caption||'', tags:j.tags||[], link:j.link||null, media_url:j.media_url, created_at:j.created_at}); }catch{} } } }catch{}
  idx.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)); await upsertText(IDX.moments, JSON.stringify(idx,null,2), 'rebuild moments index'); sessionStorage.removeItem('mh:index:moments'); toast('Indexes rebuilt'); };

// ===== Studio Pro (batch posting with per-line captions) =====
byId('studio-run').onclick = async ()=>{
  try{
    if(!currentLogin()) return alert('Sign in to an app account first');
    const files=byId('studio-files').files; if(!files?.length) return alert('Select files');
    const caps=(byId('studio-captions').value||'').split('\n'); const tags=parseTags(byId('studio-tags').value);
    const total=files.length; let done=0; const st=byId('studio-status'); st.textContent=`Posting 0/${total}…`;
    await limitConcurrency(Array.from(files),3, async (f,idx)=>{ const caption=caps[idx]?.trim()||''; const m=await postOneMomentFromFile(f,{caption,tags,link:null}); await prependToIndex(m); done++; st.textContent=`Posted ${done}/${total}`; });
    st.textContent='Batch complete ✓'; await loadFeed(); await loadVertical(); toast('Studio batch posted');
  }catch(err){ alert(err.message); }
};

// ===== Boot =====
(async ()=>{ /* ready */ })();
</script>
</body>
</html>
