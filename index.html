<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Moments Hub ‚Äî Tubonge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .radial-bg{background-image:
      radial-gradient(1200px 600px at 20% -10%, rgba(59,130,246,.10), transparent),
      radial-gradient(900px 400px at 90% -10%, rgba(217,70,239,.10), transparent)}
    .card{box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .chip{font-size:.7rem;padding:.2rem .5rem;border-radius:999px;background:rgba(0,0,0,.08)}
    .dropzone{border:1px dashed rgba(0,0,0,.15)}
    .story-ring{box-shadow:0 0 0 2px #e879f9}
    .modal-backdrop{background:rgba(0,0,0,.6)}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .safe-bottom{padding-bottom:env(safe-area-inset-bottom)}
    /* Stories viewer progress */
    .progress-bar{display:flex;gap:.25rem}
    .progress-seg{flex:1;height:3px;background:rgba(255,255,255,.35);border-radius:999px;overflow:hidden}
    .progress-seg>span{display:block;height:100%;width:0;background:white}

    /* Fancy feed grid */
    #feed{grid-auto-rows:1px}
    .m-card{--h:420; grid-row: span var(--span, 420)}
    .m-media{transition:transform .25s ease}
    .m-card:hover .m-media{transform:scale(1.015)}

    /* DM ticks */
    .tick{font-size:11px;margin-left:.25rem;opacity:.6}
    .tick.read{color:#0ea5e9;opacity:1}
    .tick.delivered{opacity:.8}

    /* Swipe-down hint */
    .swipe-hint{position:absolute;left:50%;transform:translateX(-50%);top:8px;
      background:rgba(255,255,255,.14);backdrop-filter:blur(6px);padding:.25rem .5rem;border-radius:999px;font-size:12px}

    /* Editor controls */
    .range{appearance:none;width:100%;height:4px;border-radius:999px;background:#e5e7eb;outline:none}
    .range::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:999px;background:#111827;cursor:pointer}
  </style>
</head>
<body class="min-h-screen radial-bg text-slate-900">
  <!-- HEADER -->
  <header class="sticky top-0 z-40 border-b border-black/10 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3 min-w-0">
          <div class="h-9 w-9 animate-[spin_9s_linear_infinite] rounded-xl bg-gradient-to-br from-sky-300 via-fuchsia-300 to-amber-300"></div>
          <div class="truncate">
            <div class="text-xs uppercase tracking-widest text-black/60">Moments Hub</div>
            <div class="text-lg font-extrabold leading-5 truncate">Tubonge</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Desktop tabs -->
          <nav class="hidden sm:flex flex-wrap gap-2">
            <button data-tab="feed" class="tab-btn rounded-full bg-white px-3 py-1 text-xs font-semibold shadow">Feed</button>
            <button data-tab="moments" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">Moments</button>
            <button data-tab="dms" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">DMs</button>
            <button data-tab="account" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">Account</button>
            <button id="adminTabBtn" data-tab="admin" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 hidden">Admin</button>
          </nav>
          <button id="openLoginBtn" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Connect</button>
        </div>
      </div>
    </div>
    <!-- Mobile tabs -->
    <div class="sm:hidden border-t border-black/10 bg-white/90">
      <div id="mobileTabs" class="mx-auto max-w-6xl px-4 py-2 flex gap-2 overflow-x-auto no-scrollbar">
        <button data-tab="feed" class="tab-btn rounded-full bg-white px-3 py-1 text-xs font-semibold shadow whitespace-nowrap">Feed</button>
        <button data-tab="moments" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 whitespace-nowrap">Moments</button>
        <button data-tab="dms" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 whitespace-nowrap">DMs</button>
        <button data-tab="account" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 whitespace-nowrap">Account</button>
        <button id="adminTabBtnMobile" data-tab="admin" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70 whitespace-nowrap hidden">Admin</button>
      </div>
    </div>
  </header>

  <!-- STATUS BAR -->
  <div class="bg-amber-50 border-b border-amber-200">
    <div class="mx-auto max-w-6xl px-4 py-2 text-[12px] text-amber-900 flex items-center justify-between gap-3">
      <div id="conn-status" class="truncate">Not connected. Tap <strong>Connect</strong> and enter your PAT.</div>
      <div class="hidden sm:block text-black/60"><em>Owner/repo default to <code>hunter9201/momentshub-data</code>.</em></div>
    </div>
  </div>

  <main class="mx-auto max-w-6xl px-4 py-6 space-y-8 pb-32 md:pb-8">
    <!-- FEED -->
    <section id="tab-feed" class="space-y-6">
      <!-- Toolbar -->
      <div class="flex flex-wrap gap-2 justify-end">
        <button id="openComposeBtn" class="rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs font-semibold shadow-sm">‚ûï Moment</button>
        <button id="openStoryComposeBtn" class="rounded-full border border-black/10 bg-white/80 px-4 py-2 text-xs font-semibold shadow-sm">üì∏ Story</button>
        <button id="openStudioBtn" class="rounded-full border border-fuchsia-200 bg-white/80 px-4 py-2 text-xs font-semibold shadow-sm">üé¨ Studio Pro</button>
      </div>

      <!-- Stories row -->
      <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
        <div class="flex items-center justify-between gap-2">
          <div class="text-xs uppercase tracking-widest text-black/50">Stories (48-hour)</div>
          <div class="chip">Tap to view ‚Ä¢ Swipe down to close</div>
        </div>
        <div id="stories-row" class="mt-3 flex gap-3 overflow-x-auto pb-2 no-scrollbar"></div>
      </div>

      <!-- Feed grid -->
      <div id="feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <div id="feed-more-wrap" class="flex justify-center"></div>
    </section>

    <!-- MOMENTS (vertical viewer) -->
    <section id="tab-moments" class="hidden space-y-4">
      <div class="rounded-2xl border border-black/10 bg-white/80 p-0 card">
        <div class="flex items-center justify-between p-4">
          <div class="text-xs uppercase tracking-widest text-black/50">For You</div>
          <div class="flex items-center gap-2 text-xs">
            <span class="chip">Scroll / swipe</span><span class="chip">J/K = next/prev</span>
          </div>
        </div>
        <div id="mom-vertical" class="px-3 pb-4 space-y-4" style="scroll-snap-type:y mandatory; max-height: 80svh; overflow:auto;"></div>
      </div>
    </section>

    <!-- DMs -->
    <section id="tab-dms" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- People -->
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="flex items-center justify-between">
            <div class="text-xs uppercase tracking-widest text-black/50">Chats</div>
            <div class="text-[11px] text-black/50"><span class="chip">Unread ‚Ä¢ ‚úì‚úì Read</span></div>
          </div>
          <input id="dm-search" class="mt-2 w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm" placeholder="Search profiles‚Ä¶">
          <div id="dm-people" class="mt-2 max-h-[26rem] overflow-y-auto space-y-1 no-scrollbar"></div>
        </div>
        <!-- Thread -->
        <div class="md:col-span-2 rounded-2xl border border-black/10 bg-white/80 p-0 card">
          <div class="flex items-center justify-between p-3 border-b border-black/10">
            <div id="dm-header" class="text-xs text-black/60">Pick a person to chat.</div>
            <div class="text-[11px] text-black/50">Tap a bubble to delete ‚Ä¢ Hold for more</div>
          </div>
          <div id="dm-log" class="h-[28rem] md:h-[32rem] overflow-y-auto p-3 no-scrollbar bg-white/70"></div>
          <div class="p-3 flex gap-2 border-t border-black/10 bg-white/70">
            <input id="dm-msg" class="w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm" placeholder="Type a message‚Ä¶">
            <button id="dm-send" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm font-semibold" disabled>Send</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ACCOUNT -->
    <section id="tab-account" class="hidden space-y-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- App Account -->
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">App Account</div>
          <div id="appacct-box" class="mt-3 text-sm text-black/70">Not signed in to an app account.</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="openSignInBtn" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Sign in</button>
            <button id="openRegisterBtn" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Register</button>
            <button id="signOutBtn" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm hidden">Sign out</button>
          </div>
        </div>
        <!-- Profile editor -->
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card lg:col-span-2">
          <div class="text-xs uppercase tracking-widest text-black/50">Profile</div>
          <div class="mt-3 grid gap-2 text-sm">
            <input id="pf-name" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Display name">
            <input id="pf-handle" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Handle (optional)">
            <button id="pf-save" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Save profile</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- GitHub identity (for commits) -->
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">GitHub Identity</div>
          <div id="profile-box" class="mt-3 text-sm">
            <div class="text-black/60">Connect with the button in the header (used to write to repo).</div>
          </div>
        </div>
        <!-- Admin -->
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card md:col-span-2">
          <div class="text-xs uppercase tracking-widest text-black/50">Admin Setup</div>
          <div class="mt-3 text-sm">
            <button id="adm-init" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Initialize data folders</button>
            <button id="adm-addme" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Add me as admin</button>
            <div class="text-[11px] text-black/60 mt-2">Creates: <code>profiles/ moments/ stories/ media/ dms/ indexes/ engagement/</code>.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="tab-admin" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">Metrics</div>
          <div id="adm-metrics" class="mt-3 text-sm grid gap-1">
            <div>Total users: ‚Ä¶</div>
            <div>Moments: ‚Ä¶</div>
            <div>Stories (active): ‚Ä¶</div>
          </div>
          <div class="mt-3">
            <button id="btn-rebuild-indexes" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Rebuild indexes</button>
          </div>
        </div>
        <div class="md:col-span-2 rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">Users</div>
          <input id="adm-search" class="mt-3 rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm w-full" placeholder="Search by name/handle/login">
          <div id="adm-users" class="mt-3 text-sm space-y-2 max-h-[26rem] overflow-y-auto no-scrollbar"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MOBILE ACTION BAR -->
  <div id="mobile-actionbar" class="fixed bottom-0 inset-x-0 z-40 md:hidden bg-white/95 backdrop-blur border-t border-black/10 safe-bottom">
    <div class="mx-auto max-w-6xl px-4 py-2 grid grid-cols-3 gap-2">
      <button id="fabCompose" class="rounded-full border border-black/10 bg-white px-3 py-2 text-sm font-semibold shadow-sm">‚ûï Moment</button>
      <button id="fabStory" class="rounded-full border border-black/10 bg-white px-3 py-2 text-sm font-semibold shadow-sm">üì∏ Story</button>
      <button id="fabStudio" class="rounded-full border border-fuchsia-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm">üé¨ Studio</button>
    </div>
  </div>

  <!-- MODALS -->

  <!-- GitHub login -->
  <div id="modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-md rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Connect to GitHub</h3>
        <button id="closeLoginBtn" class="text-black/50">‚úï</button>
      </div>
      <div class="mt-3 grid gap-2 text-sm">
        <div class="grid grid-cols-[1fr_auto] gap-2 items-center">
          <input id="gh-owner" class="rounded-xl border border-black/10 bg-black/5 px-3 py-2" value="hunter9201" disabled>
          <button id="gh-adv1" class="text-[11px] px-2 py-1 rounded border border-black/10 bg-white/80">Change</button>
        </div>
        <div class="grid grid-cols-[1fr_auto] gap-2 items-center">
          <input id="gh-repo" class="rounded-xl border border-black/10 bg-black/5 px-3 py-2" value="momentshub-data" disabled>
          <button id="gh-adv2" class="text-[11px] px-2 py-1 rounded border border-black/10 bg-white/80">Change</button>
        </div>
        <input id="gh-branch" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" value="main" placeholder="Branch (e.g., main)">
        <input id="gh-token" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="GitHub PAT (repo:contents) ‚Äî NOT SAVED" type="password">
        <button id="gh-connect" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Connect</button>
        <div id="gh-msg" class="text-[11px] text-black/60">Only your PAT is required. Owner/repo default to <code>hunter9201/momentshub-data</code>.</div>
      </div>
    </div>
  </div>

  <!-- Compose Moments (Studio Pro is used for batch; keep this for future UI) -->
  <div id="compose-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-2xl h-[min(90svh,720px)] overflow-auto rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between sticky top-0 bg-white z-10 pb-2">
        <h3 class="text-sm font-semibold">Create Moments</h3>
        <button id="closeComposeBtn" class="text-black/50">‚úï</button>
      </div>
      <div class="mt-1 grid gap-2 text-sm">
        <label class="dropzone rounded-xl border border-black/10 bg-white/80 px-3 py-4 shadow-sm cursor-pointer text-center">
          üì§ Drop or select files (images/videos)
          <input id="mom-files" type="file" accept="video/*,image/*" class="hidden" multiple>
        </label>
        <div class="text-[11px] text-black/60">Tip: click a thumbnail to edit (rotate, flip, brightness, contrast, resize, watermark) before posting.</div>
        <div id="mom-previews" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
        <input id="mom-caption" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Caption (used for all)" />
        <input id="mom-tags" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="#tags (comma separated)" />
        <input id="mom-link" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Optional link (https://)" />
        <div class="flex items-center justify-between gap-2 sticky bottom-0 bg-white pt-2">
          <div id="mom-progress" class="text-[11px] text-black/60">No files selected.</div>
          <div class="flex gap-2">
            <button id="mom-clear" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs">Clear</button>
            <button id="mom-posts" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Post Selected Files</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compose Stories -->
  <div id="story-compose-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-2xl h-[min(90svh,720px)] overflow-auto rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between sticky top-0 bg-white z-10 pb-2">
        <h3 class="text-sm font-semibold">Create Stories</h3>
        <button id="closeStoryComposeBtn" class="text-black/50">‚úï</button>
      </div>
      <div class="grid gap-2 text-sm">
        <label class="dropzone rounded-xl border border-black/10 bg-white/80 px-3 py-4 shadow-sm cursor-pointer text-center">
          üéûÔ∏è Select files for stories
          <input id="story-files" type="file" accept="video/*,image/*" class="hidden" multiple>
        </label>
        <div class="text-[11px] text-black/60">Tap a thumbnail to edit before posting. Stories expire in 48 hours.</div>
        <div id="story-previews" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
        <div class="flex justify-between items-center">
          <div id="story-status" class="text-[11px] text-black/60">No batch loaded.</div>
          <button id="story-post" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Post Stories</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Moment Viewer -->
  <div id="moment-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-black/10 bg-white p-0 card overflow-hidden">
      <div class="flex items-center justify-between px-4 py-2 border-b border-black/10">
        <div class="flex items-center gap-3" id="moment-author"></div>
        <div class="flex items-center gap-2">
          <button id="moment-delete-btn" class="hidden text-red-600 text-sm">üóë Delete</button>
          <button id="closeMomentBtn" class="text-black/50 px-2 py-1">‚úï</button>
        </div>
      </div>
      <div class="grid grid-cols-1">
        <div class="bg-black/90 text-white p-2" id="moment-media"></div>
        <div class="p-3 space-y-3 max-h-[70svh] overflow-auto">
          <div id="moment-caption" class="text-sm"></div>
          <div class="flex items-center gap-3 text-sm sticky top-0 bg-white pt-2">
            <button id="moment-like-btn" class="rounded-full border border-black/10 bg-white px-3 py-1">‚ù§Ô∏è <span id="moment-like-count">0</span></button>
            <div class="text-xs text-black/60"><span id="moment-comment-count">0</span> comments</div>
          </div>
          <div id="moment-comments" class="space-y-2"></div>
          <div class="flex gap-2">
            <input id="moment-comment-input" class="flex-1 rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm" placeholder="Write a comment‚Ä¶">
            <button id="moment-comment-send" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm font-semibold">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stories Viewer -->
  <div id="stories-viewer" class="hidden fixed inset-0 z-50 modal-backdrop">
    <div class="relative w-full h-full">
      <div class="absolute inset-0 flex items-center justify-center">
        <div id="sv-card" class="relative w-[min(420px,96vw)] h-[92svh] rounded-2xl overflow-hidden bg-black text-white touch-pan-y">
          <div class="swipe-hint">‚Üì Swipe down to close</div>
          <div class="absolute top-0 inset-x-0 p-3">
            <div class="progress-bar" id="sv-progress"></div>
            <div class="mt-2 flex items-center justify-between text-sm">
              <div class="flex items-center gap-2" id="sv-header"></div>
              <div class="flex items-center gap-2">
                <button id="sv-delete" class="hidden text-red-400">üóë</button>
                <button id="sv-close" class="text-white/80">‚úï</button>
              </div>
            </div>
          </div>
          <div id="sv-media" class="absolute inset-0 grid place-items-center"></div>
          <button id="sv-prev" class="absolute left-0 inset-y-0 w-1/2 opacity-0">prev</button>
          <button id="sv-next" class="absolute right-0 inset-y-0 w-1/2 opacity-0">next</button>
          <div class="absolute bottom-0 inset-x-0 p-3 bg-gradient-to-t from-black/60 to-transparent">
            <div id="sv-caption" class="text-sm"></div>
            <div class="mt-2 flex items-center gap-3 text-sm">
              <button id="sv-like-btn" class="rounded-full bg-white/10 px-3 py-1">‚ù§Ô∏è <span id="sv-like-count">0</span></button>
              <span class="text-white/70"><span id="sv-comment-count">0</span> comments</span>
            </div>
            <div class="mt-2 flex gap-2">
              <input id="sv-comment-input" class="flex-1 rounded-xl bg-white/90 text-black px-3 py-2 text-sm" placeholder="Reply‚Ä¶">
              <button id="sv-comment-send" class="rounded-xl bg-white/90 text-black px-3 py-2 text-sm font-semibold">Send</button>
            </div>
            <div id="sv-comments" class="mt-2 space-y-1 max-h-32 overflow-y-auto text-[13px] no-scrollbar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sign In -->
  <div id="signin-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-md rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Sign in (App Account)</h3>
        <button id="closeSigninBtn" class="text-black/50">‚úï</button>
      </div>
      <div class="mt-3 grid gap-2 text-sm">
        <input id="si-login" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Username (profile login)">
        <input id="si-pin" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" type="password" placeholder="PIN">
        <button id="si-go" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Sign in</button>
        <div class="text-[11px] text-black/60">You must be connected to GitHub to read/write profiles.</div>
      </div>
    </div>
  </div>

  <!-- Register -->
  <div id="register-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-md rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Register (New App Account)</h3>
        <button id="closeRegisterBtn" class="text-black/50">‚úï</button>
      </div>
      <div class="mt-3 grid gap-2 text-sm">
        <input id="rg-login" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Username (unique)">
        <input id="rg-name" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Display name">
        <input id="rg-handle" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Handle (optional)">
        <input id="rg-pin" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" type="password" placeholder="PIN (4-8 digits)">
        <button id="rg-go" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Create Account</button>
        <div class="text-[11px] text-black/60">Stores your profile in <code>profiles/&lt;username&gt;.json</code>.</div>
      </div>
    </div>
  </div>

  <!-- Studio Pro (Batch) -->
  <div id="studio-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-2xl h-[min(90svh,720px)] overflow-auto rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between sticky top-0 bg-white z-10 pb-2">
        <h3 class="text-sm font-semibold">Studio Pro (Batch)</h3>
        <button id="closeStudioBtn" class="text-black/50">‚úï</button>
      </div>
      <div class="grid gap-3 text-sm">
        <div class="text-black/70">Quick caption presets, tags helper, and bulk posting.</div>
        <label class="dropzone rounded-xl border border-black/10 bg-white/80 px-3 py-4 shadow-sm cursor-pointer text-center">
          üéûÔ∏è Select files for a batch
          <input id="studio-files" type="file" accept="video/*,image/*" class="hidden" multiple>
        </label>
        <textarea id="studio-captions" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2 h-28" placeholder="One caption per line (line 1 ‚Üí file 1, etc.)"></textarea>
        <input id="studio-tags" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="#global, #tags, #for, #all" />
        <div class="flex justify-between items-center">
          <div id="studio-status" class="text-[11px] text-black/60">No batch loaded.</div>
          <button id="studio-run" class="rounded-full border border-black/10 bg-white/80 px-3 py-2 text-xs font-semibold shadow-sm">Post Batch</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lightweight Editor Modal -->
  <div id="edit-modal" class="hidden fixed inset-0 z-50 grid place-items-center modal-backdrop p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-black/10 bg-white p-4 card">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">Quick Edit</h3>
        <button id="closeEditBtn" class="text-black/50">‚úï</button>
      </div>
      <div class="grid md:grid-cols-2 gap-4 mt-3">
        <div class="bg-black/80 rounded-xl grid place-items-center aspect-[4/3]">
          <canvas id="edit-canvas" class="max-w-full max-h-full"></canvas>
          <video id="edit-video" class="hidden max-w-full max-h-full" playsinline></video>
        </div>
        <div class="text-sm">
          <div class="grid gap-2">
            <div class="font-semibold">Transforms</div>
            <div class="flex flex-wrap gap-2">
              <button id="ed-rot" class="rounded border border-black/10 px-3 py-1">‚Üª Rotate 90¬∞</button>
              <button id="ed-flipH" class="rounded border border-black/10 px-3 py-1">‚áã Flip H</button>
              <button id="ed-flipV" class="rounded border border-black/10 px-3 py-1">‚áµ Flip V</button>
            </div>
            <div class="font-semibold mt-2">Adjust</div>
            <label>Brightness <input id="ed-bright" type="range" min="50" max="150" value="100" class="range"></label>
            <label>Contrast <input id="ed-contrast" type="range" min="50" max="150" value="100" class="range"></label>
            <label>Scale <input id="ed-scale" type="range" min="50" max="150" value="100" class="range"></label>
            <label>Watermark <input id="ed-water" class="rounded-xl border border-black/10 px-2 py-1 w-full" placeholder="optional text"></label>
            <div id="ed-video-only" class="hidden">
              <div class="font-semibold mt-2">Video (metadata only)</div>
              <label>Start (s) <input id="ed-vstart" type="number" min="0" value="0" class="rounded border border-black/10 px-2 py-1 w-24"></label>
              <label>End (s) <input id="ed-vend" type="number" min="0" value="0" class="rounded border border-black/10 px-2 py-1 w-24"></label>
              <label class="inline-flex items-center gap-2 mt-1"><input id="ed-vmute" type="checkbox"> Mute</label>
            </div>
            <div class="flex justify-end gap-2 mt-3">
              <button id="ed-reset" class="rounded-full border border-black/10 bg-white px-3 py-1 text-xs">Reset</button>
              <button id="ed-apply" class="rounded-full border border-black/10 bg-white px-3 py-1 text-xs font-semibold">Apply</button>
            </div>
            <div class="text-[11px] text-black/60">Edits are applied to images (canvas). Videos store edit metadata and upload original.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
<!-- =========================
PART 2 ‚Äî CORE SCRIPTS (Utils, GitHub, Stories/Moments/Feed, Connect defaults, Embedded Studio)
========================= -->
<script>
// ===== Utilities & State =====
const byId = (id)=>document.getElementById(id);

// Modal refs
const modal = byId('modal'),
      composeModal = byId('compose-modal'),
      momentModal = byId('moment-modal'),
      storiesViewer = byId('stories-viewer'),
      signinModal = byId('signin-modal'),
      registerModal = byId('register-modal'),
      studioModal = byId('studio-modal');

// Global state (Part 3 may extend this with app account data)
const state = { owner:'', repo:'', branch:'main', token:'', me:null, isAdmin:false, user:null };

// Provide a placeholder for currentLogin() so Part 2 works even before Part 3 augments accounts
function currentLogin(){ return state.user?.login || state.me?.login || null; }

const show = el => el?.classList.remove('hidden');
const hide = el => el?.classList.add('hidden');
const setStatus = (t, ok=false)=>{ const el = byId('conn-status'); if(el) el.innerHTML = ok? `<span class="text-green-700">${t}</span>`:t; };
const toast = (msg)=>{ const t=document.createElement('div'); t.className='fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] rounded-full bg-black text-white text-xs px-3 py-2 shadow-lg'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2200); };

// Tabs
const switchTab = (t)=>{ ['feed','moments','dms','account','admin'].forEach(k=> byId('tab-'+k)?.classList.toggle('hidden', k!==t)); updateActiveTabs(t); };
const updateActiveTabs = (active)=> document.querySelectorAll('.tab-btn').forEach(btn=>{
  const on = btn.dataset.tab===active;
  btn.classList.toggle('bg-white', on);
  btn.classList.toggle('shadow', on);
  btn.classList.toggle('text-black/70', !on);
});
document.querySelectorAll('.tab-btn').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));
switchTab('feed');

// Buttons (top bar + FABs)
byId('openLoginBtn')?.addEventListener('click', ()=>{ presetRepoDefaults(); show(modal); });
byId('closeLoginBtn')?.addEventListener('click', ()=> hide(modal));
byId('openComposeBtn')?.addEventListener('click', ()=> openStudio('moment'));
byId('openStoryComposeBtn')?.addEventListener('click', ()=> triggerStoryPicker());
byId('openStudioBtn')?.addEventListener('click', ()=> openStudio('moment'));
byId('closeStudioBtn')?.addEventListener('click', ()=> hide(studioModal));

byId('fabCompose')?.addEventListener('click', ()=> openStudio('moment'));
byId('fabStory')?.addEventListener('click', ()=> triggerStoryPicker());
byId('fabStudio')?.addEventListener('click', ()=> openStudio('moment'));

byId('closeComposeBtn')?.addEventListener('click', ()=> hide(composeModal));
byId('closeMomentBtn')?.addEventListener('click', ()=> hide(momentModal));

byId('sv-close')?.addEventListener('click', ()=>{ stopStoryTimer(); hide(storiesViewer); resetStoriesDrag(); });
storiesViewer?.addEventListener('click', (e)=>{ if(e.target===storiesViewer){ stopStoryTimer(); hide(storiesViewer); resetStoriesDrag(); } });

// ===== GitHub Client (no backend) =====
const GH_API='https://api.github.com';
const rawURL=(p)=>`https://raw.githubusercontent.com/${state.owner}/${state.repo}/${state.branch}/${p}`;

async function gh(method, url, body){
  const res = await fetch(url, {method, headers:{
    'Accept':'application/vnd.github+json',
    ...(state.token? {'Authorization':'Bearer '+state.token}:{})
  }, body: body? JSON.stringify(body): undefined});
  if(!res.ok){ const t=await res.text().catch(()=> ''); throw new Error(`${res.status}: ${t}`); }
  return res.json();
}
async function ghGet(path){
  return gh('GET', `${GH_API}/repos/${state.owner}/${state.repo}/contents/${encodeURIComponent(path)}?ref=${state.branch}`);
}
async function ghGetSha(path){ try{ const j=await ghGet(path); return j.sha; }catch{return null;} }
function bufToBase64(buf){ let binary=''; const bytes=new Uint8Array(buf), chunk=0x8000; for(let i=0;i<bytes.length;i+=chunk){ binary+=String.fromCharCode.apply(null, bytes.subarray(i,i+chunk)); } return btoa(binary); }
async function upsertText(path, text, message){
  const sha=await ghGetSha(path);
  return gh('PUT', `${GH_API}/repos/${state.owner}/${state.repo}/contents/${encodeURIComponent(path)}`, {
    message:message||`update ${path}`,
    content:btoa(unescape(encodeURIComponent(text))),
    branch:state.branch,
    ...(sha?{sha}:{})
  });
}
async function upsertBinary(path,file,message){
  const buf=await file.arrayBuffer();
  const content=bufToBase64(buf);
  const sha=await ghGetSha(path);
  return gh('PUT', `${GH_API}/repos/${state.owner}/${state.repo}/contents/${encodeURIComponent(path)}`, {
    message:message||`upload ${path}`,
    content,
    branch:state.branch,
    ...(sha?{sha}:{})
  });
}
async function ghDelete(path, message){
  const sha=await ghGetSha(path);
  if(!sha) throw new Error('Not found');
  return gh('DELETE', `${GH_API}/repos/${state.owner}/${state.repo}/contents/${encodeURIComponent(path)}`, {
    message:message||`delete ${path}`, sha, branch:state.branch
  });
}

async function ensureDirs(){
  const mk=async p=>{ try{ await upsertText(`${p}/.gitkeep`, '', `init ${p}`);}catch{} };
  await mk('profiles'); await mk('moments'); await mk('stories'); await mk('media');
  await mk('dms'); await mk('indexes'); await mk('engagement/moments'); await mk('engagement/stories');
}

// Defaults for Connect modal
function presetRepoDefaults(){
  const ownerIn=byId('gh-owner'), repoIn=byId('gh-repo'), branchIn=byId('gh-branch');
  if(ownerIn){ ownerIn.value='hunter9201'; ownerIn.parentElement?.style && (ownerIn.parentElement.style.display='none'); }
  if(repoIn){  repoIn.value='momentshub-data'; repoIn.parentElement?.style && (repoIn.parentElement.style.display='none'); }
  if(branchIn){ branchIn.value='main'; branchIn.placeholder='main'; }
}

// Connect button ‚Äî verifies PAT (read), then loads UI; write attempts will fail later if insufficient
byId('gh-connect')?.addEventListener('click', async ()=>{
  state.owner = (byId('gh-owner')?.value.trim()) || 'hunter9201';
  state.repo  = (byId('gh-repo')?.value.trim())  || 'momentshub-data';
  state.branch= (byId('gh-branch')?.value.trim())|| 'main';
  state.token = (byId('gh-token')?.value||'').trim();
  const msg=byId('gh-msg');

  try{
    // Identify user if PAT provided (optional)
    let me = null;
    if(state.token){
      const ures=await fetch(`${GH_API}/user`,{headers:{Authorization:'Bearer '+state.token}});
      if(!ures.ok) throw new Error('Invalid token or network');
      me = await ures.json();
    }
    state.me = me || { login: 'guest' };

    // Ensure repo reachable
    await gh('GET', `${GH_API}/repos/${state.owner}/${state.repo}`);

    setStatus(`Connected${me? ' as <strong>@'+me.login+'</strong>':''}. Repo: <code>${state.owner}/${state.repo}@${state.branch}</code>`, true);
    msg && (msg.textContent='Connected ‚úì');
    hide(modal);

    // Prepare structure & minimal profile for connected user if we can write
    try{ await ensureDirs(); }catch{}
    try{ if(me?.login) await ensureProfile(me.login); }catch{}
    await loadAdminStatus().catch(()=>{});
    await Promise.all([loadFeed(), loadStories(), loadVertical(), renderProfileBox()]);
    toast('Connected');
  }catch(err){
    msg && (msg.textContent = err.message || 'Failed to connect');
    setStatus('Not connected. Check your token/repo.');
  }
});

async function ensureProfile(login){
  const p=`profiles/${login}.json`; let cur=null; try{ cur=await (await fetch(rawURL(p),{cache:'no-store'})).json(); }catch{}
  if(!cur || !cur.login){
    const data={ login, name: state.me?.name || login, handle:null, role:'user', status:'active', created_at:new Date().toISOString() };
    try{ await upsertText(p, JSON.stringify(data,null,2), `create profile ${login}`); }catch{}
  }
}
async function loadAdminStatus(){
  try{
    const admins=await (await fetch(rawURL('admins.json'),{cache:'no-store'})).json();
    state.isAdmin=Array.isArray(admins)&&admins.includes(state.me?.login);
    byId('adminTabBtn')?.classList.toggle('hidden', !state.isAdmin);
    byId('adminTabBtnMobile')?.classList.toggle('hidden', !state.isAdmin);
  }catch{
    byId('adminTabBtn')?.classList.add('hidden');
    byId('adminTabBtnMobile')?.classList.add('hidden');
    state.isAdmin=false;
  }
}
async function renderProfileBox(){
  const box=byId('profile-box');
  if(!box){ return; }
  if(!state.me){ box.innerHTML=`<div class="text-black/60">Not connected.</div>`; return; }
  const ppath=`profiles/${state.me.login}.json`; let prof=null; try{ prof=await (await fetch(rawURL(ppath),{cache:'no-store'})).json(); }catch{}
  box.innerHTML=`<div class="flex items-center gap-3">
    <div class="h-12 w-12 rounded-full border border-black/10 bg-white/70 grid place-items-center text-xs">${(prof?.name||state.me.login).slice(0,1)}</div>
    <div><div class="font-semibold">${prof?.name||state.me.login} <span class="chip">${prof?.role||'user'}</span></div>
    <div class="text-xs text-black/60">@${state.me.login} ${prof?.handle? '‚Ä¢ @'+prof.handle:''}</div></div></div>`;
}

// ===== Engagement (likes/comments) =====
const ENG = { moments: id=>`engagement/moments/${id}.json`, stories: id=>`engagement/stories/${id}.json` };
async function ensureEngagement(kind,id){
  const path=ENG[kind](id);
  try{ await (await fetch(rawURL(path),{cache:'no-store'})).json(); }
  catch{ try{ await upsertText(path, JSON.stringify({likes:[],comments:[]},null,2), `init engagement ${kind}/${id}`);}catch{} }
}
async function readEngagement(kind,id){
  const path=ENG[kind](id);
  try{ return await (await fetch(rawURL(path),{cache:'no-store'})).json(); }
  catch{ return {likes:[],comments:[]}; }
}
async function writeEngagement(kind,id,data){
  const path=ENG[kind](id);
  await upsertText(path, JSON.stringify(data,null,2), `engage ${kind}/${id}`);
}
async function toggleLike(kind,id){
  const who=currentLogin(); if(!who) return alert('Sign in to an app account first');
  await ensureEngagement(kind,id);
  const data=await readEngagement(kind,id);
  const i=(data.likes||[]).indexOf(who);
  if(i>=0) data.likes.splice(i,1); else data.likes.push(who);
  await writeEngagement(kind,id,data);
  return data;
}
async function addComment(kind,id,text){
  const who=currentLogin(); if(!who) return alert('Sign in to an app account first');
  await ensureEngagement(kind,id);
  const data=await readEngagement(kind,id);
  data.comments=data.comments||[];
  data.comments.push({id:`${Date.now()}_${Math.random().toString(36).slice(2)}`,from:who,text,ts:Date.now()});
  await writeEngagement(kind,id,data);
}
function renderComments(list){
  return (list||[]).slice(-150).map(c=>`<div class="rounded-xl bg-black/5 p-2">
    <div class="text-[11px] text-black/60">@${c.from} ‚Ä¢ ${new Date(c.ts).toLocaleString()}</div>
    <div class="text-sm">${c.text}</div></div>`).join('');
}
async function refreshEngagementUI(kind,id,{likeCountEl, commentCountEl, commentsHost}){
  const data=await readEngagement(kind,id);
  if(likeCountEl) likeCountEl.textContent=data.likes?.length||0;
  if(commentCountEl) commentCountEl.textContent=data.comments?.length||0;
  if(commentsHost) commentsHost.innerHTML=renderComments(data.comments);
}

// ===== Embedded Studio (quick edits before upload) =====
let STUDIO_MODE = 'moment'; // 'moment' | 'story'
let STUDIO_FILES = []; // [{file, previewURL, rotateDeg, brightness, kind}]
function resetStudio(){
  STUDIO_FILES=[]; byId('studio-files') && (byId('studio-files').value='');
  byId('studio-captions') && (byId('studio-captions').value='');
  byId('studio-tags') && (byId('studio-tags').value='');
  byId('studio-status') && (byId('studio-status').textContent='No batch loaded.');
}
function openStudio(mode){
  STUDIO_MODE = mode || 'moment';
  show(studioModal);
  byId('studio-status') && (byId('studio-status').textContent = `Editing for ${STUDIO_MODE==='story'?'Stories (9:16)':'Moments (4:5)'}`);
}
function triggerStoryPicker(){
  openStudio('story');
  const input = document.createElement('input');
  input.type='file'; input.accept='video/*,image/*'; input.multiple=true;
  input.onchange = (e)=>{ if(e.target.files?.length){ loadStudioFiles(e.target.files); } };
  input.click();
}
byId('studio-files')?.addEventListener('change', (e)=>{ if(e.target.files?.length){ loadStudioFiles(e.target.files); } });

async function loadStudioFiles(fileList){
  STUDIO_FILES = Array.from(fileList).map(f=>({file:f, previewURL:URL.createObjectURL(f), rotateDeg:0, brightness:100, kind:(f.type||'').startsWith('video')?'video':'image'}));
  const caps=byId('studio-captions'); if(caps && !caps.value.trim()) caps.value = STUDIO_FILES.map(()=> '').join('\n');
  renderStudioPreviews();
  toast(`${STUDIO_FILES.length} file(s) ready. Tap thumbnails to edit.`);
}
function renderStudioPreviews(){
  let grid = byId('studio-grid');
  if(!grid){
    const holder = studioModal?.querySelector('.grid.gap-3.text-sm');
    grid = document.createElement('div'); grid.id='studio-grid';
    grid.className='grid grid-cols-2 sm:grid-cols-3 gap-3';
    holder && holder.appendChild(grid);
  }
  grid.innerHTML = STUDIO_FILES.map((it,idx)=>`
    <div class="rounded-xl border border-black/10 bg-white/70 overflow-hidden relative">
      ${it.kind==='video'
        ? `<video src="${it.previewURL}" class="w-full aspect-[${STUDIO_MODE==='story'?'9/16':'4/5'}] object-cover" muted playsinline loop></video>`
        : `<img src="${it.previewURL}" class="w-full aspect-[${STUDIO_MODE==='story'?'9/16':'4/5'}] object-cover" style="filter:brightness(${it.brightness}%); transform:rotate(${it.rotateDeg}deg);" />`}
      <div class="absolute bottom-0 inset-x-0 p-2 bg-white/80 flex items-center justify-between text-[11px]">
        <div class="flex gap-1">
          <button data-ed="rot" data-idx="${idx}" class="rounded px-2 py-1 border border-black/10">‚Üª</button>
          ${it.kind==='image'? `<button data-ed="b-" data-idx="${idx}" class="rounded px-2 py-1 border border-black/10">‚òÄÔ∏é‚àí</button>
          <button data-ed="b+" data-idx="${idx}" class="rounded px-2 py-1 border border-black/10">‚òÄÔ∏é+</button>`:''}
        </div>
        <button data-ed="rm" data-idx="${idx}" class="rounded px-2 py-1 border border-red-200 text-red-600">Remove</button>
      </div>
    </div>
  `).join('');

  grid.onclick = (e)=>{
    const btn = e.target.closest('[data-ed]'); if(!btn) return;
    const idx = +btn.dataset.idx; const ed = btn.dataset.ed; const it = STUDIO_FILES[idx]; if(!it) return;
    if(ed==='rot'){ it.rotateDeg = (it.rotateDeg+90)%360; }
    if(ed==='b-'){ it.brightness = Math.max(50, it.brightness-10); }
    if(ed==='b+'){ it.brightness = Math.min(200, it.brightness+10); }
    if(ed==='rm'){ STUDIO_FILES.splice(idx,1); }
    renderStudioPreviews();
  };
}

async function blobFromImageFile(it){
  return new Promise((resolve,reject)=>{
    try{
      const img = new Image(); img.crossOrigin='anonymous';
      img.onload = ()=>{
        const aspect = (STUDIO_MODE==='story')? (9/16) : (4/5);
        let w = img.width, h = img.height;
        const rad = it.rotateDeg * Math.PI/180;
        const sin = Math.abs(Math.sin(rad)), cos=Math.abs(Math.cos(rad));
        const rw = Math.round(w*cos + h*sin), rh=Math.round(w*sin + h*cos);

        // crop box to target aspect
        let cw = rw, ch = Math.round(rw / aspect);
        if(ch > rh){ ch = rh; cw = Math.round(ch * aspect); }

        // final canvas long edge 1080
        const scale = 1080 / Math.max(cw,ch);
        const fw = Math.round(cw*scale), fh = Math.round(ch*scale);

        const c = document.createElement('canvas'); c.width=fw; c.height=fh;
        const ctx = c.getContext('2d');
        ctx.filter = `brightness(${it.brightness}%)`;
        ctx.translate(fw/2, fh/2);
        ctx.rotate(rad);

        const drawW = Math.round(w*scale), drawH = Math.round(h*scale);
        ctx.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);

        c.toBlob((b)=> b? resolve(b):reject(new Error('toBlob failed')), 'image/jpeg', 0.92);
      };
      img.onerror = reject;
      img.src = it.previewURL;
    }catch(e){ reject(e); }
  });
}

// Studio "Post Batch"
byId('studio-run')?.addEventListener('click', postStudioBatch);

async function postStudioBatch(){
  if(!currentLogin()) return alert('Sign in to an app account first');
  const tags = parseTags(byId('studio-tags')?.value||'');
  const caps = (byId('studio-captions')?.value||'').split('\n');
  const total = STUDIO_FILES.length;
  if(!total) return alert('No files loaded');

  const st=byId('studio-status'); st && (st.textContent=`Posting 0/${total}‚Ä¶`);
  let done=0;

  // simple 3-worker queue
  const queue = [...STUDIO_FILES].entries();
  const workers = Array.from({length:3}, async ()=> {
    for(const [idx,it] of queue){
      let fileToSend = it.file;
      if(it.kind==='image'){ const blob = await blobFromImageFile(it); fileToSend = new File([blob], it.file.name.replace(/\.(png|jpg|jpeg|webp|gif)$/i,'.jpg'), {type:'image/jpeg'}); }
      if(STUDIO_MODE==='moment'){
        const meta = await postOneMomentFromFile(fileToSend, {caption: (caps[idx]||'').trim(), tags, link:null});
        await prependToIndex(meta);
      }else{
        await postOneStoryFromFile(fileToSend);
      }
      done++; st && (st.textContent=`Posted ${done}/${total}`);
    }
  });
  await Promise.all(workers);

  st && (st.textContent='Batch complete ‚úì');
  await loadFeed(); await loadVertical(); await loadStories();
  hide(studioModal); hide(composeModal);
  resetStudio();
}

// ===== Moments & Stories helpers =====
function chip(t){ return `<span class="inline-flex items-center rounded-full bg-black/5 px-2 py-0.5 text-[11px]">${t}</span>`; }
function timeAgo(ts){
  const d = new Date(ts||Date.now()); const s = Math.floor((Date.now()-d.getTime())/1000);
  if(s<60) return `${s}s`; const m=Math.floor(s/60); if(m<60) return `${m}m`;
  const h=Math.floor(m/60); if(h<24) return `${h}h`;
  const dd=Math.floor(h/24); if(dd<7) return `${dd}d`;
  return d.toLocaleDateString();
}
function cardHTML(m, author, counts={likes:0,comments:0}){
  const mine = currentLogin() && currentLogin()===m.author;
  const media = m.kind==='video'
    ? `<video class="w-full aspect-[4/5] object-cover rounded-xl" src="${m.media_url}" muted playsinline loop></video>`
    : `<img class="w-full aspect-[4/5] object-cover rounded-xl" src="${m.media_url}" alt="">`;
  return `
  <article class="rounded-2xl border bg-white shadow p-0 overflow-hidden group" data-moment="${m.id}">
    <header class="flex items-center justify-between px-3 pt-3">
      <div class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-full bg-gradient-to-br from-sky-200 to-fuchsia-200 grid place-items-center text-xs border border-black/10">${(author?.name||m.author||'‚Äî').slice(0,1)}</div>
        <div>
          <div class="text-sm font-semibold">${author?.name||m.author}</div>
          <div class="text-[11px] text-black/50">@${m.author} ‚Ä¢ ${timeAgo(m.created_at)}</div>
        </div>
      </div>
      <div class="flex items-center gap-1">
        ${m.link ? `<a href="${m.link}" target="_blank" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">üîó</a>` : ``}
        ${mine ? `<button class="rounded-full border border-red-200 bg-white/80 px-3 py-1 text-xs font-semibold text-red-600 shadow-sm" data-delete-moment="${m.id}">Delete</button>`:''}
      </div>
    </header>
    <div class="mt-3 mx-3 rounded-xl overflow-hidden ring-1 ring-black/5">
      ${media}
    </div>
    <div class="px-3 py-2 flex items-center gap-2 text-sm">
      <button class="rounded-full border border-black/10 bg-white/80 px-3 py-1" data-like-moment="${m.id}">‚ù§Ô∏è <span class="like-count">${counts.likes||0}</span></button>
      <button class="rounded-full border border-black/10 bg-white/80 px-3 py-1" data-view="${m.id}">üí¨ <span class="comment-count">${counts.comments||0}</span></button>
      <span class="ml-auto text-[11px] text-black/50">${(m.tags||[]).slice(0,3).map(t=>`#${t}`).join(' ')}</span>
    </div>
    <div class="px-3 pb-3 text-sm"><span class="font-semibold">${author?.name||m.author}</span> ${m.caption||''}</div>
  </article>`;
}

async function uploadMedia(file){
  if(!state.me) throw new Error('Connect to GitHub first');
  const ext=(file.name.split('.').pop()||'bin').toLowerCase();
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const d=new Date(); const year=d.getUTCFullYear(); const month=String(d.getUTCMonth()+1).padStart(2,'0');
  const path=`media/${year}/${month}/${currentLogin()||state.me.login}_${id}.${ext}`;
  await upsertBinary(path,file,`upload media ${id}`); return rawURL(path);
}
async function postOneMomentFromFile(file, common){
  const author = currentLogin(); if(!author) throw new Error('Sign in to an app account first');
  const kind=(file.type||'').startsWith('video')?'video':'image';
  const media_url=await uploadMedia(file);
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const meta={ id, author, kind, caption: common.caption||'', tags: common.tags||[], link: common.link||null, media_url, created_at:new Date().toISOString() };
  await upsertText(`moments/${id}.json`, JSON.stringify(meta,null,2), `post moment ${id}`);
  await ensureEngagement('moments', id);
  return meta;
}
async function postOneStoryFromFile(file){
  const author = currentLogin(); if(!author) throw new Error('Sign in to an app account first');
  const kind=(file.type||'').startsWith('video')?'video':'image';
  const media_url=await uploadMedia(file);
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const created_at=new Date().toISOString(); const expires_at=new Date(Date.now()+48*3600*1000).toISOString();
  const s={ id, author, kind, caption:'', media_url, created_at, expires_at };
  await upsertText(`stories/${id}.json`, JSON.stringify(s,null,2), `add story ${id}`); await ensureEngagement('stories',id); return s;
}
function parseTags(v){ return (v||'').split(',').map(s=>s.trim().replace(/^#/,'')).filter(Boolean); }

// ===== Stories (list, viewer with swipe-down) =====
function storyChipHTML(user,firstStory,name){
  const media = firstStory.kind==='image'
    ? `<img src="${firstStory.media_url}" class="h-full w-full object-cover">`
    : `<video src="${firstStory.media_url}" class="h-full w-full object-cover" muted></video>`;
  return `<button class="flex flex-col items-center gap-1" data-story-author="${user}">
    <span class="block h-16 w-16 rounded-full story-ring overflow-hidden">${media}</span>
    <span class="text-[11px] max-w-24 truncate">${name||user}</span>
  </button>`;
}
async function listJsonIn(path){
  let items=[]; try{ const arr=await ghGet(path); items=Array.isArray(arr)? arr.filter(x=>x.type==='file' && x.name.endsWith('.json')):[]; }catch{}
  const out=[]; for(const it of items){ try{ const j=await (await fetch(it.download_url,{cache:'no-store'})).json(); out.push(j);}catch{} } return out;
}
let STORY_GROUPS=[]; // [{author,name,stories:[]}]
async function loadStories(){
  const row=byId('stories-row'); if(!row) return;
  row.innerHTML='';
  const stories=await listJsonIn('stories'); const now=Date.now();
  const live=stories.filter(s=> new Date(s.expires_at).getTime() > now).sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
  const byAuthor=new Map();
  for(const s of live){ if(!byAuthor.has(s.author)) byAuthor.set(s.author,[]); byAuthor.get(s.author).push(s); }
  STORY_GROUPS=[]; 
  for(const [author,arr] of byAuthor.entries()){
    let prof=null; try{ prof=await (await fetch(rawURL(`profiles/${author}.json`),{cache:'no-store'})).json(); }catch{}
    STORY_GROUPS.push({author, name:prof?.name||author, stories:arr});
  }
  if(!STORY_GROUPS.length){ row.innerHTML=`<div class="text-sm text-black/60">No active stories.</div>`; return; }
  row.innerHTML = STORY_GROUPS.map(g=> storyChipHTML(g.author, g.stories[g.stories.length-1], g.name)).join('');
}
async function deleteStory(id){
  if(!currentLogin()) return alert('Sign in first');
  await ghDelete(`stories/${id}.json`, `delete story ${id}`);
  try{ await ghDelete(`engagement/stories/${id}.json`, `delete story engagement ${id}`);}catch{}
  toast('Story deleted');
  hide(storiesViewer); stopStoryTimer(); resetStoriesDrag();
  await loadStories();
}

let svGroup=0, svIdx=0, svTimer=null, svVideo=null;
const IMG_DURATION=6000;
function stopStoryTimer(){ if(svTimer){ clearTimeout(svTimer); svTimer=null; } if(svVideo){ try{svVideo.pause();}catch{} svVideo=null; } }
function startStoryTimer(ms){ stopStoryTimer(); svTimer=setTimeout(()=> nextStory(), ms); animateProgress(ms); }
function animateProgress(ms){ const segs=byId('sv-progress')?.querySelectorAll('.progress-seg>span')||[]; const cur=segs[svIdx]; if(cur){ cur.style.transition=`width ${ms}ms linear`; requestAnimationFrame(()=> cur.style.width='100%'); } }

function renderStory(){
  const g=STORY_GROUPS[svGroup]; if(!g) return hide(storiesViewer);
  const s=g.stories[svIdx]; if(!s) return hide(storiesViewer);
  const mine = currentLogin()===g.author;
  byId('sv-header').innerHTML=`<div class="h-8 w-8 rounded-full bg-white/20 grid place-items-center text-xs">${g.name.slice(0,1)}</div><div>${g.name} <span class="text-white/60 text-xs">@${g.author}</span></div>
    ${mine? `<button id="sv-del" class="ml-2 rounded-full px-2 py-1 text-xs bg-white/10 hover:bg-white/20">Delete</button>`:''}`;
  byId('sv-progress').innerHTML = g.stories.map((_,i)=>`<div class="progress-seg"><span style="width:${i<svIdx?'100%':'0'}"></span></div>`).join('');
  const mediaHost=byId('sv-media'); mediaHost.innerHTML=''; const isVid=s.kind==='video';
  if(isVid){
    const v=document.createElement('video'); v.src=s.media_url; v.playsInline=true; v.muted=true; v.autoplay=true; v.className='max-h-full max-w-full';
    mediaHost.appendChild(v); svVideo=v;
    v.onloadedmetadata=()=>{ startStoryTimer(v.duration? v.duration*1000: IMG_DURATION); v.play().catch(()=>{}); };
    v.onended=()=> nextStory();
  } else {
    const img=document.createElement('img'); img.src=s.media_url; img.className='max-h-full max-w-full object-contain'; mediaHost.appendChild(img); startStoryTimer(IMG_DURATION);
  }
  byId('sv-caption').textContent=s.caption||'';
  refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') });
  byId('sv-like-btn').onclick=async ()=>{ await toggleLike('stories', s.id); refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') }); };
  byId('sv-comment-send').onclick=async ()=>{ const input=byId('sv-comment-input'); const text=(input.value||'').trim(); if(!text) return; await addComment('stories', s.id, text); input.value=''; refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') }); };
  const delBtn = document.getElementById('sv-del'); if(delBtn) delBtn.onclick=()=> deleteStory(s.id);
}

// swipe/drag down to dismiss
let dragStartY=null, dragging=false, dragMax=0;
function resetStoriesDrag(){ const box = storiesViewer?.querySelector('.relative.w-full.h-full'); if(box){ box.style.transform=''; box.style.opacity=''; } dragStartY=null; dragging=false; dragMax=0; }
storiesViewer?.addEventListener('pointerdown', (e)=>{ dragStartY=e.clientY; dragging=true; dragMax=0; storiesViewer.setPointerCapture(e.pointerId); });
storiesViewer?.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dy = Math.max(0, e.clientY - dragStartY); dragMax = Math.max(dragMax, dy);
  const box = storiesViewer.querySelector('.relative.w-full.h-full'); if(box){ box.style.transform=`translateY(${dy}px)`; box.style.opacity=String(Math.max(0.3, 1 - dy/400)); }
});
storiesViewer?.addEventListener('pointerup', (e)=>{ if(!dragging) return; dragging=false; storiesViewer.releasePointerCapture(e.pointerId);
  if(dragMax>120){ stopStoryTimer(); hide(storiesViewer); resetStoriesDrag(); }
  else { const box = storiesViewer.querySelector('.relative.w-full.h-full'); if(box){ box.style.transition='transform .2s, opacity .2s'; box.style.transform=''; box.style.opacity=''; setTimeout(()=>{ box.style.transition=''; }, 250); } }
});

function nextStory(){ const g=STORY_GROUPS[svGroup]; if(svIdx<g.stories.length-1){ svIdx++; renderStory(); } else if(svGroup<STORY_GROUPS.length-1){ svGroup++; svIdx=0; renderStory(); } else { hide(storiesViewer); stopStoryTimer(); resetStoriesDrag(); } }
function prevStory(){ if(svIdx>0){ svIdx--; renderStory(); } else if(svGroup>0){ svGroup--; svIdx=STORY_GROUPS[svGroup].stories.length-1; renderStory(); } }
byId('sv-next')?.addEventListener('click', nextStory);
byId('sv-prev')?.addEventListener('click', prevStory);
byId('stories-row')?.addEventListener('click', (e)=>{
  const btn=e.target.closest('[data-story-author]'); if(!btn) return;
  const author=btn.getAttribute('data-story-author'); svGroup=STORY_GROUPS.findIndex(g=>g.author===author); svIdx=0; show(storiesViewer); renderStory();
});

// ===== Feed & Moments (grid) + Vertical viewer =====
const IDX={ moments:'indexes/moments.json' };
let momentsIndex=null, feedCursor=0, vertCursor=0;
const PAGE_SIZE=10, VERT_PAGE=5;

async function readRaw(path){ try{ return await (await fetch(rawURL(path),{cache:'no-store'})).json(); }catch{ return null; } }
async function writeIndex(path,data,msg){ try{ await upsertText(path, JSON.stringify(data,null,2), msg||'update index'); }catch{} }

async function loadMomentsIndex({force=false}={}){
  if(!force){
    if(momentsIndex) return momentsIndex;
    const cached=sessionStorage.getItem('mh:index:moments'); if(cached){ try{ momentsIndex=JSON.parse(cached); return momentsIndex;}catch{} }
  }
  let idx=await readRaw(IDX.moments);
  if(!idx){
    let arr=[]; try{ arr=await ghGet('moments'); }catch{}
    idx=[];
    for(const it of (arr||[])){
      if(it.type==='file' && it.name.endsWith('.json')){
        try{ const j=await (await fetch(it.download_url,{cache:'no-store'})).json();
          idx.push({ id:j.id, author:j.author, created_at:j.created_at, caption:j.caption||'', tags:j.tags||[], link:j.link||null, media_url:j.media_url, kind:j.kind||'image' });
        }catch{}
      }
    }
    try{ await writeIndex(IDX.moments, idx, 'build moments index'); }catch{}
  }
  idx.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  momentsIndex=idx; try{ sessionStorage.setItem('mh:index:moments', JSON.stringify(idx)); }catch{} return idx;
}
async function prependToIndex(meta){
  let idx=await loadMomentsIndex({force:true}) || [];
  idx.unshift({ id:meta.id, author:meta.author, kind:meta.kind, caption:meta.caption||'', tags:meta.tags||[], link:meta.link||null, media_url:meta.media_url, created_at:meta.created_at});
  try{ await writeIndex(IDX.moments, idx, 'append moments index'); }catch{}
  sessionStorage.removeItem('mh:index:moments');
}
async function deleteMoment(id, author){
  if(!currentLogin()) return alert('Sign in first');
  if(currentLogin()!==author && !state.isAdmin) return alert('Only owner/admin can delete');
  await ghDelete(`moments/${id}.json`, `delete moment ${id}`);
  try{ await ghDelete(`engagement/moments/${id}.json`, `delete engagement ${id}`);}catch{}
  // remove from index
  let idx = await loadMomentsIndex({force:true}) || [];
  idx = idx.filter(x=>x.id!==id);
  await writeIndex(IDX.moments, idx, 'remove moment from index');
  sessionStorage.removeItem('mh:index:moments');
  await loadFeed(); await loadVertical();
  toast('Moment deleted');
}

async function renderFeedPage(reset=false){
  const host=byId('feed'); if(!host) return;
  if(reset){ feedCursor=0; host.innerHTML=''; }
  const idx=await loadMomentsIndex({force:false});
  const slice=idx.slice(feedCursor, feedCursor+PAGE_SIZE);
  if(slice.length===0 && feedCursor===0){ host.innerHTML=`<div class="text-sm text-black/60">No posts yet.</div>`; return; }

  const authorMap=new Map();
  for(const m of slice){
    if(!authorMap.has(m.author)){
      try{ const p=await (await fetch(rawURL(`profiles/${m.author}.json`),{cache:'no-store'})).json(); authorMap.set(m.author,p); }
      catch{ authorMap.set(m.author,null); }
    }
    const wrap=document.createElement('div');
    wrap.innerHTML=cardHTML(m, authorMap.get(m.author));
    const el=wrap.firstElementChild; host.appendChild(el);

    // counts
    refreshEngagementUI('moments', m.id, {
      likeCountEl: el.querySelector('.like-count'),
      commentCountEl: el.querySelector('.comment-count')
    });

    // dbl-click like
    el.addEventListener('dblclick', async ()=>{
      await toggleLike('moments', m.id);
      refreshEngagementUI('moments', m.id, {
        likeCountEl: el.querySelector('.like-count'),
        commentCountEl: el.querySelector('.comment-count')
      });
    });

    // delete if mine
    const del=el.querySelector('[data-delete-moment]');
    if(del){ del.onclick=()=> deleteMoment(m.id, m.author); }
  }
  feedCursor += slice.length;

  let moreBtn=byId('feed-more');
  if(feedCursor < idx.length){
    if(!moreBtn){
      moreBtn=document.createElement('button'); moreBtn.id='feed-more';
      moreBtn.className='w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm shadow-sm';
      moreBtn.textContent='Load more'; moreBtn.onclick=()=>renderFeedPage(false);
      byId('feed-more-wrap')?.appendChild(moreBtn);
    }
  } else if(moreBtn){ moreBtn.remove(); }
}
async function loadFeed(){ await renderFeedPage(true); }

function verticalItemHTML(m, author){
  return `<div class="rounded-2xl overflow-hidden border border-black/10 bg-black/90 text-white relative" style="scroll-snap-align:center">
    <div class="aspect-[9/16] w-full relative">
      ${m.kind==='video'
        ? `<video class="vitem absolute inset-0 h-full w-full object-cover" src="${m.media_url}" playsinline muted loop></video>`
        : `<img class="absolute inset-0 h-full w-full object-cover" src="${m.media_url}" alt="">`}
      <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/70 to-black/0">
        <div class="text-sm font-semibold truncate">${author?.name||m.author}</div>
        <div class="text-sm opacity-90 truncate">${m.caption||''}</div>
        <div class="text-xs opacity-70 truncate">${(m.tags||[]).map(t=>'#'+t).join(' ')}</div>
      </div>
    </div>
  </div>`;
}
async function renderVerticalPage(reset=false){
  const host=byId('mom-vertical'); if(!host) return;
  if(reset){ vertCursor=0; host.innerHTML=''; }
  const idx=await loadMomentsIndex({force:false}); const chunk=idx.slice(vertCursor, vertCursor+VERT_PAGE);
  const authorMap=new Map();
  for(const m of chunk){
    if(!authorMap.has(m.author)){
      try{ const p=await (await fetch(rawURL(`profiles/${m.author}.json`),{cache:'no-store'})).json(); authorMap.set(m.author,p);}
      catch{ authorMap.set(m.author,null);}
    }
    host.insertAdjacentHTML('beforeend', verticalItemHTML(m, authorMap.get(m.author)));
  }
  vertCursor += chunk.length;

  const vids=[...host.querySelectorAll('.vitem')];
  if('IntersectionObserver' in window){
    const obs=new IntersectionObserver((entries)=> entries.forEach(en=>{
      const v=en.target;
      if(en.isIntersecting && en.intersectionRatio>0.6){ v.play().catch(()=>{}); } else { v.pause?.(); }
    }), {threshold:[0,0.6,1]});
    vids.forEach(v=>obs.observe(v));
  } else vids.forEach(v=> v.play && v.play().catch(()=>{}));
}
async function loadVertical(){ await renderVerticalPage(true); }

// Feed actions (like/comment open)
byId('feed')?.addEventListener('click', async (e)=>{
  const likeBtn=e.target.closest('[data-like-moment]'); if(likeBtn){
    const id=likeBtn.getAttribute('data-like-moment');
    await toggleLike('moments', id);
    await refreshEngagementUI('moments', id, {
      likeCountEl: likeBtn.querySelector('.like-count'),
      commentCountEl: likeBtn.parentElement.querySelector('.comment-count')
    });
    return;
  }
  const viewBtn=e.target.closest('[data-view]'); if(viewBtn){ openMomentViewer(viewBtn.getAttribute('data-view')); }
});

async function openMomentViewer(id){
  const idx=await loadMomentsIndex({force:false}); const m=idx.find(x=>x.id===id); if(!m) return alert('Moment not found');
  let prof=null; try{ prof=await (await fetch(rawURL(`profiles/${m.author}.json`),{cache:'no-store'})).json(); }catch{}
  byId('moment-author').innerHTML=`<div class="h-8 w-8 rounded-full bg-black/10 grid place-items-center text-xs">${(prof?.name||m.author).slice(0,1)}</div><div><div class="text-sm font-semibold">${prof?.name||m.author}</div><div class="text-[11px] text-black/60">@${m.author}</div></div>`;
  byId('moment-media').innerHTML = m.kind==='video'
    ? `<video src="${m.media_url}" class="max-h-[65svh] w-full object-contain" controls playsinline></video>`
    : `<img src="${m.media_url}" class="max-h-[65svh] w-full object-contain" />`;
  byId('moment-caption').textContent=m.caption||'';
  await ensureEngagement('moments', id);
  await refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') });
  byId('moment-like-btn').onclick=async ()=>{ await toggleLike('moments', id); refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') }); };
  byId('moment-comment-send').onclick=async ()=>{ const i=byId('moment-comment-input'); const text=(i.value||'').trim(); if(!text) return; await addComment('moments', id, text); i.value=''; refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') }); };
  show(momentModal);
}

// Moments tab: J/K scroll helper
(function(){
  const host=byId('mom-vertical');
  if(!host) return;
  host.addEventListener('scroll', ()=>{ if(host.scrollTop + host.clientHeight >= host.scrollHeight - 200){ renderVerticalPage(false); } });
  document.addEventListener('keydown',(e)=>{
    if(byId('tab-moments')?.classList.contains('hidden')) return;
    if(e.key.toLowerCase()==='j') host.scrollBy({top:host.clientHeight*0.9, behavior:'smooth'});
    if(e.key.toLowerCase()==='k') host.scrollBy({top:-host.clientHeight*0.9, behavior:'smooth'});
  });
})();

// ===== Boot (prefill defaults + try loading public data) =====
(async ()=>{
  try{ presetRepoDefaults(); }catch{}
  // Load public data (read-only) so UI isn't blank before connecting
  await loadStories().catch(()=>{});
  await loadFeed().catch(()=>{});
  await loadVertical().catch(()=>{});
})();
</script>
<!-- =========================
PART 3 ‚Äî APP ACCOUNTS, DMS (WhatsApp-style), Stories swipe-to-dismiss & delete, Moments/Feed polish, Admin & Boot
========================= -->
<script>
// ---------- Moments (enhanced display) ----------
function chip(t){ return `<span class="inline-flex items-center rounded-full bg-black/5 px-2 py-0.5 text-[11px]">${t}</span>`; }
function timeAgo(ts){
  const d = new Date(ts||Date.now()); const s = Math.floor((Date.now()-d.getTime())/1000);
  if(s<60) return `${s}s`; const m=Math.floor(s/60); if(m<60) return `${m}m`;
  const h=Math.floor(m/60); if(h<24) return `${h}h`;
  const dd=Math.floor(h/24); if(dd<7) return `${dd}d`;
  return d.toLocaleDateString();
}
function cardHTML(m, author, counts={likes:0,comments:0}){
  const mine = currentLogin() && currentLogin()===m.author;
  const media = m.kind==='video'
    ? `<video class="w-full aspect-[4/5] object-cover rounded-xl" src="${m.media_url}" muted playsinline loop></video>`
    : `<img class="w-full aspect-[4/5] object-cover rounded-xl" src="${m.media_url}" alt="">`;
  return `
  <article class="rounded-2xl border bg-white shadow p-0 overflow-hidden group" data-moment="${m.id}">
    <header class="flex items-center justify-between px-3 pt-3">
      <div class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-full bg-gradient-to-br from-sky-200 to-fuchsia-200 grid place-items-center text-xs border border-black/10">${(author?.name||m.author||'‚Äî').slice(0,1)}</div>
        <div>
          <div class="text-sm font-semibold">${author?.name||m.author}</div>
          <div class="text-[11px] text-black/50">@${m.author} ‚Ä¢ ${timeAgo(m.created_at)}</div>
        </div>
      </div>
      <div class="flex items-center gap-1">
        ${m.link ? `<a href="${m.link}" target="_blank" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">üîó</a>` : ``}
        ${mine ? `<button class="rounded-full border border-red-200 bg-white/80 px-3 py-1 text-xs font-semibold text-red-600 shadow-sm" data-delete-moment="${m.id}">Delete</button>`:''}
      </div>
    </header>
    <div class="mt-3 mx-3 rounded-xl overflow-hidden ring-1 ring-black/5">
      ${media}
    </div>
    <div class="px-3 py-2 flex items-center gap-2 text-sm">
      <button class="rounded-full border border-black/10 bg-white/80 px-3 py-1" data-like-moment="${m.id}">‚ù§Ô∏è <span class="like-count">${counts.likes||0}</span></button>
      <button class="rounded-full border border-black/10 bg-white/80 px-3 py-1" data-view="${m.id}">üí¨ <span class="comment-count">${counts.comments||0}</span></button>
      <span class="ml-auto text-[11px] text-black/50">${(m.tags||[]).slice(0,3).map(t=>`#${t}`).join(' ')}</span>
    </div>
    <div class="px-3 pb-3 text-sm"><span class="font-semibold">${author?.name||m.author}</span> ${m.caption||''}</div>
  </article>`;
}

// utilities used by Studio & posting
async function uploadMedia(file){
  if(!state.me) throw new Error('Connect to GitHub first');
  const ext=(file.name.split('.').pop()||'bin').toLowerCase();
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const d=new Date(); const year=d.getUTCFullYear(); const month=String(d.getUTCMonth()+1).padStart(2,'0');
  const path=`media/${year}/${month}/${currentLogin()||state.me.login}_${id}.${ext}`;
  await upsertBinary(path,file,`upload media ${id}`); return rawURL(path);
}
async function postOneMomentFromFile(file, common){
  if(!currentLogin()) throw new Error('Sign in to an app account first');
  const kind=(file.type||'').startsWith('video')?'video':'image';
  const media_url=await uploadMedia(file);
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const meta={ id, author: currentLogin(), kind, caption: common.caption, tags: common.tags, link: common.link||null, media_url, created_at:new Date().toISOString() };
  await upsertText(`moments/${id}.json`, JSON.stringify(meta,null,2), `post moment ${id}`);
  await ensureEngagement('moments', id);
  return meta;
}
async function postOneStoryFromFile(file){
  if(!currentLogin()) throw new Error('Sign in to an app account first');
  const kind=(file.type||'').startsWith('video')?'video':'image';
  const media_url=await uploadMedia(file);
  const id=`${Date.now()}_${Math.random().toString(36).slice(2)}`;
  const created_at=new Date().toISOString(); const expires_at=new Date(Date.now()+48*3600*1000).toISOString();
  const s={ id, author: currentLogin(), kind, caption:'', media_url, created_at, expires_at };
  await upsertText(`stories/${id}.json`, JSON.stringify(s,null,2), `add story ${id}`); await ensureEngagement('stories',id); return s;
}
function parseTags(v){ return (v||'').split(',').map(s=>s.trim().replace(/^#/,'')).filter(Boolean); }
function limitConcurrency(items,limit,worker){ return new Promise((resolve,reject)=>{ let i=0,active=0,results=[]; const run=()=>{ while(active<limit && i<items.length){ const cur=items[i]; const idx=i; i++; active++; Promise.resolve(worker(cur,idx)).then(r=>results[idx]=r).catch(reject).finally(()=>{ active--; if(i>=items.length&&active===0) resolve(results); else run(); }); } }; run(); }); }

// ---------- Stories (list, viewer, swipe-down to dismiss, delete by owner) ----------
function storyChipHTML(user,firstStory,name){
  const media = firstStory.kind==='image'
    ? `<img src="${firstStory.media_url}" class="h-full w-full object-cover">`
    : `<video src="${firstStory.media_url}" class="h-full w-full object-cover" muted></video>`;
  return `<button class="flex flex-col items-center gap-1" data-story-author="${user}">
    <span class="block h-16 w-16 rounded-full story-ring overflow-hidden">${media}</span>
    <span class="text-[11px] max-w-24 truncate">${name||user}</span>
  </button>`;
}

async function listJsonIn(path){
  let items=[]; try{ const arr=await ghGet(path); items=Array.isArray(arr)? arr.filter(x=>x.type==='file' && x.name.endsWith('.json')):[]; }catch{}
  const out=[]; for(const it of items){ try{ const j=await (await fetch(it.download_url)).json(); out.push(j);}catch{} } return out;
}

let STORY_GROUPS=[]; // [{author,name,stories:[]}]
async function loadStories(){
  const row=byId('stories-row'); row.innerHTML='';
  const stories=await listJsonIn('stories'); const now=Date.now();
  const live=stories.filter(s=> new Date(s.expires_at).getTime() > now).sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
  const byAuthor=new Map();
  for(const s of live){ if(!byAuthor.has(s.author)) byAuthor.set(s.author,[]); byAuthor.get(s.author).push(s); }
  STORY_GROUPS=[]; 
  for(const [author,arr] of byAuthor.entries()){ let prof=null; try{ prof=await (await fetch(rawURL(`profiles/${author}.json`))).json(); }catch{} STORY_GROUPS.push({author, name:prof?.name||author, stories:arr}); }
  if(!STORY_GROUPS.length){ row.innerHTML=`<div class="text-sm text-black/60">No active stories.</div>`; return; }
  row.innerHTML = STORY_GROUPS.map(g=> storyChipHTML(g.author, g.stories[g.stories.length-1], g.name)).join('');
}
async function deleteStory(id){
  if(!currentLogin()) return alert('Sign in first');
  // only author can delete
  // just remove the JSON + engagement; media left to keep history
  await ghDelete(`stories/${id}.json`, `delete story ${id}`);
  try{ await ghDelete(`engagement/stories/${id}.json`, `delete story engagement ${id}`);}catch{}
  toast('Story deleted');
  hide(storiesViewer); stopStoryTimer(); resetStoriesDrag();
  await loadStories();
}

let svGroup=0, svIdx=0, svTimer=null, svVideo=null;
const IMG_DURATION=6000;
function stopStoryTimer(){ if(svTimer){ clearTimeout(svTimer); svTimer=null; } if(svVideo){ try{svVideo.pause();}catch{} svVideo=null; } }
function startStoryTimer(ms){ stopStoryTimer(); svTimer=setTimeout(()=> nextStory(), ms); animateProgress(ms); }
function animateProgress(ms){ const segs=byId('sv-progress').querySelectorAll('.progress-seg>span'); const cur=segs[svIdx]; if(cur){ cur.style.transition=`width ${ms}ms linear`; requestAnimationFrame(()=> cur.style.width='100%'); } }

function renderStory(){
  const g=STORY_GROUPS[svGroup]; if(!g) return hide(storiesViewer);
  const s=g.stories[svIdx]; if(!s) return hide(storiesViewer);
  const mine = currentLogin()===g.author;
  byId('sv-header').innerHTML=`<div class="h-8 w-8 rounded-full bg-white/20 grid place-items-center text-xs">${g.name.slice(0,1)}</div><div>${g.name} <span class="text-white/60 text-xs">@${g.author}</span></div>
    ${mine? `<button id="sv-del" class="ml-2 rounded-full px-2 py-1 text-xs bg-white/10 hover:bg-white/20">Delete</button>`:''}`;
  byId('sv-progress').innerHTML = g.stories.map((_,i)=>`<div class="progress-seg"><span style="width:${i<svIdx?'100%':'0'}"></span></div>`).join('');
  const mediaHost=byId('sv-media'); mediaHost.innerHTML=''; const isVid=s.kind==='video';
  if(isVid){ const v=document.createElement('video'); v.src=s.media_url; v.playsInline=true; v.muted=true; v.autoplay=true; v.className='max-h-full max-w-full'; mediaHost.appendChild(v); svVideo=v; v.onloadedmetadata=()=>{ startStoryTimer(v.duration? v.duration*1000: IMG_DURATION); v.play().catch(()=>{}); }; v.onended=()=> nextStory(); }
  else { const img=document.createElement('img'); img.src=s.media_url; img.className='max-h-full max-w-full object-contain'; mediaHost.appendChild(img); startStoryTimer(IMG_DURATION); }
  byId('sv-caption').textContent=s.caption||'';
  refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') });
  byId('sv-like-btn').onclick=async ()=>{ await toggleLike('stories', s.id); refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') }); };
  byId('sv-comment-send').onclick=async ()=>{ const input=byId('sv-comment-input'); const text=(input.value||'').trim(); if(!text) return; await addComment('stories', s.id, text); input.value=''; refreshEngagementUI('stories', s.id, { likeCountEl: byId('sv-like-count'), commentCountEl: byId('sv-comment-count'), commentsHost: byId('sv-comments') }); };
  const delBtn = document.getElementById('sv-del'); if(delBtn) delBtn.onclick=()=> deleteStory(s.id);
}

// swipe/drag down to dismiss like WhatsApp
let dragStartY=null, dragging=false, dragMax=0;
function resetStoriesDrag(){ const box = storiesViewer.querySelector('.relative.w-full.h-full'); if(box){ box.style.transform=''; box.style.opacity=''; } dragStartY=null; dragging=false; dragMax=0; }
storiesViewer.addEventListener('pointerdown', (e)=>{ dragStartY=e.clientY; dragging=true; dragMax=0; storiesViewer.setPointerCapture(e.pointerId); });
storiesViewer.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dy = Math.max(0, e.clientY - dragStartY); dragMax = Math.max(dragMax, dy);
  const box = storiesViewer.querySelector('.relative.w-full.h-full'); if(box){ box.style.transform=`translateY(${dy}px)`; box.style.opacity=String(Math.max(0.3, 1 - dy/400)); }
});
storiesViewer.addEventListener('pointerup', (e)=>{ if(!dragging) return; dragging=false; storiesViewer.releasePointerCapture(e.pointerId);
  if(dragMax>120){ stopStoryTimer(); hide(storiesViewer); resetStoriesDrag(); }
  else { const box = storiesViewer.querySelector('.relative.w-full.h-full'); if(box){ box.style.transition='transform .2s, opacity .2s'; box.style.transform=''; box.style.opacity=''; setTimeout(()=>{ box.style.transition=''; }, 250); } }
});

function nextStory(){ const g=STORY_GROUPS[svGroup]; if(svIdx<g.stories.length-1){ svIdx++; renderStory(); } else if(svGroup<STORY_GROUPS.length-1){ svGroup++; svIdx=0; renderStory(); } else { hide(storiesViewer); stopStoryTimer(); resetStoriesDrag(); } }
function prevStory(){ if(svIdx>0){ svIdx--; renderStory(); } else if(svGroup>0){ svGroup--; svIdx=STORY_GROUPS[svGroup].stories.length-1; renderStory(); } }
byId('sv-next').onclick=nextStory; byId('sv-prev').onclick=prevStory;
byId('stories-row').addEventListener('click', (e)=>{ const btn=e.target.closest('[data-story-author]'); if(!btn) return; const author=btn.getAttribute('data-story-author'); svGroup=STORY_GROUPS.findIndex(g=>g.author===author); svIdx=0; show(storiesViewer); renderStory(); });

// ---------- Feed & Vertical (index + pagination, polish) ----------
const IDX={ moments:'indexes/moments.json' }; let momentsIndex=null, feedCursor=0, vertCursor=0;
const PAGE_SIZE=10, VERT_PAGE=5;

async function readRaw(path){ try{ return await (await fetch(rawURL(path),{cache:'no-store'})).json(); }catch{ return null; } }
async function writeIndex(path,data,msg){ await upsertText(path, JSON.stringify(data,null,2), msg||'update index'); }

async function loadMomentsIndex({force=false}={}){
  if(!force){ if(momentsIndex) return momentsIndex; const cached=sessionStorage.getItem('mh:index:moments'); if(cached){ try{ momentsIndex=JSON.parse(cached); return momentsIndex;}catch{} } }
  let idx=await readRaw(IDX.moments);
  if(!idx){
    let arr=[]; try{ arr=await ghGet('moments'); }catch{}
    idx=[]; for(const it of (arr||[])){ if(it.type==='file' && it.name.endsWith('.json')){ try{ const j=await (await fetch(it.download_url)).json(); idx.push({ id:j.id, author:j.author, created_at:j.created_at, caption:j.caption||'', tags:j.tags||[], link:j.link||null, media_url:j.media_url, kind:j.kind||'image' }); }catch{} } }
    try{ await writeIndex(IDX.moments, idx, 'build moments index'); }catch{}
  }
  idx.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  momentsIndex=idx; try{ sessionStorage.setItem('mh:index:moments', JSON.stringify(idx)); }catch{} return idx;
}
async function prependToIndex(meta){
  let idx=await loadMomentsIndex({force:true}) || []; idx.unshift({ id:meta.id, author:meta.author, kind:meta.kind, caption:meta.caption||'', tags:meta.tags||[], link:meta.link||null, media_url:meta.media_url, created_at:meta.created_at});
  try{ await writeIndex(IDX.moments, idx, 'append moments index'); }catch{} sessionStorage.removeItem('mh:index:moments');
}

async function deleteMoment(id, author){
  if(!currentLogin()) return alert('Sign in first');
  if(currentLogin()!==author && !state.isAdmin) return alert('Only owner/admin can delete');
  await ghDelete(`moments/${id}.json`, `delete moment ${id}`);
  try{ await ghDelete(`engagement/moments/${id}.json`, `delete engagement ${id}`);}catch{}
  // remove from index
  let idx = await loadMomentsIndex({force:true}) || [];
  idx = idx.filter(x=>x.id!==id);
  await writeIndex(IDX.moments, idx, 'remove moment from index');
  sessionStorage.removeItem('mh:index:moments');
  await loadFeed(); await loadVertical();
  toast('Moment deleted');
}

async function renderFeedPage(reset=false){
  const host=byId('feed'); if(reset){ feedCursor=0; host.innerHTML=''; }
  const idx=await loadMomentsIndex({force:false}); const slice=idx.slice(feedCursor, feedCursor+PAGE_SIZE);
  if(slice.length===0 && feedCursor===0){ host.innerHTML=`<div class="text-sm text-black/60">No posts yet.</div>`; return; }
  const authorMap=new Map();
  for(const m of slice){
    if(!authorMap.has(m.author)){ try{ const p=await (await fetch(rawURL(`profiles/${m.author}.json`))).json(); authorMap.set(m.author,p); }catch{ authorMap.set(m.author,null); } }
    const wrap=document.createElement('div'); wrap.innerHTML=cardHTML(m, authorMap.get(m.author));
    const el=wrap.firstElementChild; host.appendChild(el);
    // counts
    refreshEngagementUI('moments', m.id, { likeCountEl: el.querySelector('.like-count'), commentCountEl: el.querySelector('.comment-count') });
    // like dbl-click on media
    el.querySelector('.mx-3, .rounded-xl');
    el.addEventListener('dblclick', async ()=>{ await toggleLike('moments', m.id); refreshEngagementUI('moments', m.id, { likeCountEl: el.querySelector('.like-count'), commentCountEl: el.querySelector('.comment-count') }); });
    // delete
    const del=el.querySelector('[data-delete-moment]'); if(del){ del.onclick=()=> deleteMoment(m.id, m.author); }
  }
  feedCursor += slice.length;
  let moreBtn=document.getElementById('feed-more');
  if(feedCursor < idx.length){ if(!moreBtn){ moreBtn=document.createElement('button'); moreBtn.id='feed-more'; moreBtn.className='w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm shadow-sm'; moreBtn.textContent='Load more'; moreBtn.onclick=()=>renderFeedPage(false); host.parentElement.appendChild(moreBtn);} }
  else if(moreBtn){ moreBtn.remove(); }
}
async function loadFeed(){ await renderFeedPage(true); }

function verticalItemHTML(m, author){
  return `<div class="rounded-2xl overflow-hidden border border-black/10 bg-black/90 text-white relative" style="scroll-snap-align:center">
    <div class="aspect-[9/16] w-full relative">
      ${m.kind==='video' ? `<video class="vitem absolute inset-0 h-full w-full object-cover" src="${m.media_url}" playsinline muted loop></video>` : `<img class="absolute inset-0 h-full w-full object-cover" src="${m.media_url}" alt="">`}
      <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/70 to-black/0">
        <div class="text-sm font-semibold truncate">${author?.name||m.author}</div>
        <div class="text-sm opacity-90 truncate">${m.caption||''}</div>
        <div class="text-xs opacity-70 truncate">${(m.tags||[]).map(t=>'#'+t).join(' ')}</div>
      </div>
    </div>
  </div>`;
}
async function renderVerticalPage(reset=false){
  const host=byId('mom-vertical'); if(reset){ vertCursor=0; host.innerHTML=''; }
  const idx=await loadMomentsIndex({force:false}); const chunk=idx.slice(vertCursor, vertCursor+VERT_PAGE);
  const authorMap=new Map();
  for(const m of chunk){
    if(!authorMap.has(m.author)){ try{ const p=await (await fetch(rawURL(`profiles/${m.author}.json`))).json(); authorMap.set(m.author,p);}catch{ authorMap.set(m.author,null);} }
    host.insertAdjacentHTML('beforeend', verticalItemHTML(m, authorMap.get(m.author)));
  }
  vertCursor += chunk.length;
  const vids=[...host.querySelectorAll('.vitem')];
  if('IntersectionObserver' in window){
    const obs=new IntersectionObserver((entries)=> entries.forEach(en=>{ const v=en.target; if(en.isIntersecting && en.intersectionRatio>0.6){ v.play().catch(()=>{}); } else { v.pause(); } }), {threshold:[0,0.6,1]});
    vids.forEach(v=>obs.observe(v));
  } else vids.forEach(v=> v.play && v.play().catch(()=>{}));
}
async function loadVertical(){ await renderVerticalPage(true); }
(function(){ const host=byId('mom-vertical'); host.addEventListener('scroll', ()=>{ if(host.scrollTop + host.clientHeight >= host.scrollHeight - 200){ renderVerticalPage(false); } }); document.addEventListener('keydown',(e)=>{ if(byId('tab-moments').classList.contains('hidden')) return; if(e.key.toLowerCase()==='j') host.scrollBy({top:host.clientHeight*0.9, behavior:'smooth'}); if(e.key.toLowerCase()==='k') host.scrollBy({top:-host.clientHeight*0.9, behavior:'smooth'}); }); })();

// Feed actions (like/comment open)
byId('feed').addEventListener('click', async (e)=>{
  const likeBtn=e.target.closest('[data-like-moment]'); if(likeBtn){ const id=likeBtn.getAttribute('data-like-moment'); await toggleLike('moments', id); await refreshEngagementUI('moments', id, { likeCountEl: likeBtn.querySelector('.like-count'), commentCountEl: likeBtn.parentElement.querySelector('.comment-count') }); return; }
  const viewBtn=e.target.closest('[data-view]'); if(viewBtn){ openMomentViewer(viewBtn.getAttribute('data-view')); }
});
async function openMomentViewer(id){
  const idx=await loadMomentsIndex({force:false}); const m=idx.find(x=>x.id===id); if(!m) return alert('Moment not found');
  let prof=null; try{ prof=await (await fetch(rawURL(`profiles/${m.author}.json`))).json(); }catch{}
  byId('moment-author').innerHTML=`<div class="h-8 w-8 rounded-full bg-black/10 grid place-items-center text-xs">${(prof?.name||m.author).slice(0,1)}</div><div><div class="text-sm font-semibold">${prof?.name||m.author}</div><div class="text-[11px] text-black/60">@${m.author}</div></div>`;
  byId('moment-media').innerHTML = m.kind==='video' ? `<video src="${m.media_url}" class="max-h-[65svh] w-full object-contain" controls playsinline></video>` : `<img src="${m.media_url}" class="max-h-[65svh] w-full object-contain" />`;
  byId('moment-caption').textContent=m.caption||'';
  await ensureEngagement('moments', id);
  await refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') });
  byId('moment-like-btn').onclick=async ()=>{ await toggleLike('moments', id); refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') }); };
  byId('moment-comment-send').onclick=async ()=>{ const i=byId('moment-comment-input'); const text=(i.value||'').trim(); if(!text) return; await addComment('moments', id, text); i.value=''; refreshEngagementUI('moments', id, { likeCountEl: byId('moment-like-count'), commentCountEl: byId('moment-comment-count'), commentsHost: byId('moment-comments') }); };
  show(momentModal);
}

// ---------- App Accounts (multi-user) ----------
const currentLoginRef = () => state.user?.login || null; // kept for backward compat

function appBoxRender(){
  const box=byId('appacct-box'); const outBtn=byId('signOutBtn');
  if(state.user){
    box.innerHTML=`Signed in as <strong>@${state.user.login}</strong> (<span class="text-black/70">${state.user.name||state.user.login}</span>)`;
    outBtn.classList.remove('hidden');
  } else {
    box.textContent='Not signed in to an app account.'; outBtn.classList.add('hidden');
  }
  byId('pf-name').value = state.user?.name || '';
  byId('pf-handle').value = state.user?.handle || '';
}

async function restoreAppUser(){
  const saved = sessionStorage.getItem('mh:appUser');
  if(saved){ try{ const p=await (await fetch(rawURL(`profiles/${saved}.json`),{cache:'no-store'})).json(); state.user=p; }catch{} }
  appBoxRender();
}
async function sha256Hex(s){
  if(window.crypto?.subtle){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(s)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } return String(h);
}

byId('openSignInBtn').onclick=()=>show(signinModal);
byId('closeSigninBtn').onclick=()=>hide(signinModal);
byId('openRegisterBtn').onclick=()=>show(registerModal);
byId('closeRegisterBtn').onclick=()=>hide(registerModal);
byId('signOutBtn').onclick=()=>{ state.user=null; sessionStorage.removeItem('mh:appUser'); appBoxRender(); toast('Signed out'); };

byId('rg-go').onclick = async ()=>{
  try{
    if(!state.me) return alert('Connect to GitHub first');
    const login=byId('rg-login').value.trim(); const name=byId('rg-name').value.trim()||login; const handle=(byId('rg-handle').value.trim()||null); const pin=byId('rg-pin').value.trim();
    if(!login || !pin) return alert('Username & PIN required');
    let exists=true; try{ await (await fetch(rawURL(`profiles/${login}.json`),{cache:'no-store'})).json(); }catch{ exists=false; }
    if(exists) return alert('Username already exists');
    const pin_hash=await sha256Hex(pin);
    const prof={ login, name, handle, role:'user', status:'active', created_at:new Date().toISOString(), auth:{pin_hash} };
    await upsertText(`profiles/${login}.json`, JSON.stringify(prof,null,2), `register profile ${login}`);
    state.user=prof; sessionStorage.setItem('mh:appUser', login); appBoxRender(); hide(registerModal); toast('Account created & signed in');
    await loadPeople();
  }catch(err){ alert(err.message); }
};
byId('si-go').onclick = async ()=>{
  try{
    if(!state.me) return alert('Connect to GitHub first');
    const login=byId('si-login').value.trim(); const pin=byId('si-pin').value.trim(); if(!login||!pin) return;
    let prof=null; try{ prof=await (await fetch(rawURL(`profiles/${login}.json`),{cache:'no-store'})).json(); }catch{ }
    if(!prof?.auth?.pin_hash) return alert('Account not found or no PIN set');
    const pin_hash=await sha256Hex(pin); if(pin_hash!==prof.auth.pin_hash) return alert('Invalid PIN');
    state.user=prof; sessionStorage.setItem('mh:appUser', login); appBoxRender(); hide(signinModal); toast('Signed in');
    await loadPeople();
  }catch(err){ alert(err.message); }
};
byId('pf-save').onclick = async ()=>{
  try{
    if(!state.user) return alert('Sign in to an app account first');
    const p=`profiles/${state.user.login}.json`; let prof=null; try{ prof=await (await fetch(rawURL(p),{cache:'no-store'})).json(); }catch{}
    prof=prof||{login:state.user.login, role:'user', status:'active', created_at:new Date().toISOString()};
    prof.name = byId('pf-name').value.trim() || prof.name || state.user.login;
    prof.handle = byId('pf-handle').value.trim() || null;
    await upsertText(p, JSON.stringify(prof,null,2), `update profile ${state.user.login}`);
    state.user=prof; appBoxRender(); toast('Profile saved');
    await loadPeople();
  }catch(err){ alert(err.message); }
};

// ---------- DMS (WhatsApp-style: unread badges, ticks, delete) ----------
let DM_OTHER=null;
const pairKey=(a,b)=> [a,b].sort().join('__');
const READS = { // store per-user last read timestamp in repo
  path: (a,b,user)=> `dms_reads/${pairKey(a,b)}_${user}.json`,
  async set(a,b,user,ts){ await upsertText(this.path(a,b,user), JSON.stringify({user, last_read_ts: ts}, null, 2), `dm read ${pairKey(a,b)} ${user}`); },
  async get(a,b,user){ try{ return await (await fetch(rawURL(this.path(a,b,user)),{cache:'no-store'})).json(); }catch{ return {user, last_read_ts:0}; } }
};

async function loadPeople(){
  let list=[]; try{ const arr=await ghGet('profiles'); for(const it of arr){ if(it.type==='file' && it.name.endsWith('.json')){ try{ const p=await (await fetch(it.download_url)).json(); list.push(p);}catch{} } } }catch{}
  const my=currentLogin(); const q=(byId('dm-search').value||'').toLowerCase();
  list=list.filter(p=> [p.name,p.handle,p.login].join(' ').toLowerCase().includes(q) && p.login!==my);
  const host=byId('dm-people'); host.innerHTML='';
  // compute unread per contact (from last_read marker vs messages)
  for(const u of list){
    const thread = await readThread(my,u.login);
    const lastRead = (await READS.get(my, u.login, my)).last_read_ts || 0;
    const unread = (thread.messages||[]).filter(m=> m.to===my && m.ts>lastRead).length;
    const row=document.createElement('button'); row.className='w-full text-left rounded-xl border border-black/10 bg-white/70 px-3 py-2 shadow-sm flex items-center justify-between gap-2';
    row.innerHTML=`<div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-full border border-black/10 grid place-items-center text-[11px]">${(u.name||u.login).slice(0,1)}</div>
        <div><div class="font-semibold">${u.name||'‚Äî'} ${u.handle? '‚Ä¢ @'+u.handle:''}</div>
        <div class="text-[11px] text-black/60">@${u.login}</div></div></div>
      ${unread? `<span class="ml-2 rounded-full bg-emerald-500 text-white text-[11px] px-2 py-0.5">${unread}</span>`:''}`;
    row.onclick=()=>{ DM_OTHER=u; renderDM(); };
    host.appendChild(row);
  }
}
byId('dm-search').addEventListener('input', loadPeople);

async function readThread(a,b){ const key=pairKey(a,b); const path=`dms/${key}.json`; try{ return await (await fetch(rawURL(path),{cache:'no-store'})).json(); }catch{ return {key, messages:[]}; } }
async function writeThread(a,b,thread){ const key=pairKey(a,b); const path=`dms/${key}.json`; await upsertText(path, JSON.stringify(thread,null,2), `dm ${key}`); }

function tickHTML(m, otherLastRead){
  // ‚úì = delivered (saved), ‚úì‚úì = read (other has last_read_ts >= m.ts)
  if(m.to===DM_OTHER?.login){ return `<span class="text-[11px] ${otherLastRead>=m.ts?'text-emerald-600':'text-black/40'}">${otherLastRead>=m.ts?'‚úì‚úì':'‚úì'}</span>`; }
  return '';
}

async function renderDM(){
  const me = currentLogin(); const hdr=byId('dm-header'); const log=byId('dm-log'); const send=byId('dm-send');
  if(!me || !DM_OTHER){ hdr.textContent='Pick a person to chat.'; log.innerHTML=''; send.disabled=true; return; }
  hdr.textContent=`Chatting with ${DM_OTHER.name||'‚Äî'} (@${DM_OTHER.handle||DM_OTHER.login})`;
  send.disabled=false;
  const thread=await readThread(me, DM_OTHER.login);
  // other user's last read
  const otherRead = (await READS.get(me, DM_OTHER.login, DM_OTHER.login)).last_read_ts || 0;
  log.innerHTML = (thread.messages||[]).map(m=>{
    const mine = m.from===me;
    const cls = mine? 'text-right':''; const bubble = mine?'bg-sky-100':'bg-white/70';
    return `<div class="mb-2 ${cls}">
      <div class="inline-flex items-end gap-1">
        <button class="inline-block rounded-xl px-3 py-2 text-sm ${bubble}" data-delmsg="${m.id}">${m.text}</button>
        ${mine? tickHTML(m, otherRead):''}
      </div>
      <div class="text-[10px] text-black/50">${new Date(m.ts).toLocaleString()} ‚Ä¢ ${m.from}</div>
    </div>`;
  }).join('');
  log.scrollTop=log.scrollHeight;

  // mark as read for me (messages to me)
  const newestToMe = [...(thread.messages||[])].reverse().find(m=> m.to===me);
  if(newestToMe){ await READS.set(me, DM_OTHER.login, me, newestToMe.ts); }

  // delete on tap (own messages or admin)
  log.onclick = async (e)=>{
    const btn=e.target.closest('[data-delmsg]'); if(!btn) return;
    const id=btn.getAttribute('data-delmsg');
    const mine = btn.parentElement.parentElement.classList.contains('text-right');
    if(!mine && !state.isAdmin) return; // only own or admin
    const t=await readThread(me, DM_OTHER.login);
    t.messages=(t.messages||[]).filter(x=>x.id!==id);
    await writeThread(me, DM_OTHER.login, t);
    await renderDM();
  };
}

byId('dm-send').onclick = async ()=>{
  const me=currentLogin(); if(!me || !DM_OTHER) return alert('Sign into an app account and pick someone');
  const input=byId('dm-msg'); const text=(input.value||'').trim(); if(!text) return;
  const thread=await readThread(me, DM_OTHER.login); thread.messages=thread.messages||[];
  const msg = { id:`${Date.now()}_${Math.random().toString(36).slice(2)}`, from: me, to: DM_OTHER.login, text, ts: Date.now() };
  thread.messages.push(msg);
  await writeThread(me, DM_OTHER.login, thread); input.value='';
  await renderDM();
};

// ---------- Admin helpers ----------
byId('adm-init').onclick = async ()=>{ if(!state.me) return alert('Connect first'); await ensureDirs(); toast('Initialized folders'); };
byId('adm-addme').onclick = async ()=>{ if(!state.me) return alert('Connect first'); let arr=[]; try{ arr=await (await fetch(rawURL('admins.json'))).json(); }catch{} if(!Array.isArray(arr)) arr=[]; if(!arr.includes(state.me.login)) arr.push(state.me.login); await upsertText('admins.json', JSON.stringify(arr,null,2), 'update admins'); await loadAdminStatus(); toast('You are admin now'); };

async function renderAdmin(){
  const showBtn=(id,showit)=> byId(id).classList.toggle('hidden', !showit);
  showBtn('adminTabBtn', state.isAdmin); showBtn('adminTabBtnMobile', state.isAdmin);
  if(!state.isAdmin) return;
  let users=[]; try{ const arr=await ghGet('profiles'); for(const it of arr){ if(it.type==='file' && it.name.endsWith('.json')){ try{ users.push(await (await fetch(it.download_url)).json()); }catch{} } } }catch{}
  let moments=0; try{ const arr=await ghGet('moments'); moments=Array.isArray(arr)? arr.length:0; }catch{}
  let stories=0; try{ const arr=await ghGet('stories'); const now=Date.now(); for(const it of arr){ if(it.type==='file' && it.name.endsWith('.json')){ try{ const s=await (await fetch(it.download_url)).json(); if(new Date(s.expires_at).getTime()>now) stories++; }catch{} } } }catch{}
  byId('adm-metrics').innerHTML=`<div>Total users: ${users.length}</div><div>Moments: ${moments}</div><div>Stories (active): ${stories}</div>`;
  const q=(byId('adm-search').value||'').toLowerCase(); const host=byId('adm-users'); host.innerHTML='';
  users.filter(u=>[u.name,u.handle,u.login].join(' ').toLowerCase().includes(q)).forEach(u=>{
    const row=document.createElement('div'); row.className='rounded-xl border border-black/10 bg-white/70 p-3 shadow-sm flex items-center justify-between';
    row.innerHTML=`<div><div class="font-semibold">${u.name||'‚Äî'} ${u.handle? '‚Ä¢ @'+u.handle:''}</div><div class="text-xs text-black/60">@${u.login} ‚Ä¢ ${u.role||'user'} ‚Ä¢ ${u.status||'active'}</div></div>
      <div class="flex gap-2"><button class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-[11px]" data-act="role" data-id="${u.login}">${u.role==='admin'?'Demote':'Promote'}</button>
      <button class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-[11px]" data-act="suspend" data-id="${u.login}">${u.status==='suspended'?'Unsuspend':'Suspend'}</button></div>`;
    host.appendChild(row);
  });
  host.onclick = async (e)=>{ const btn=e.target.closest('[data-act]'); if(!btn) return; const login=btn.dataset.id; const act=btn.dataset.act; const p=`profiles/${login}.json`; let prof=null; try{ prof=await (await fetch(rawURL(p))).json(); }catch{} if(!prof) return alert('Profile missing'); if(act==='role') prof.role=(prof.role==='admin'?'user':'admin'); if(act==='suspend') prof.status=(prof.status==='suspended'?'active':'suspended'); await upsertText(p, JSON.stringify(prof,null,2), `admin update ${login}`); await renderAdmin(); };
  byId('adm-search').oninput=renderAdmin;
}
byId('btn-rebuild-indexes').onclick = async ()=>{ if(!state.isAdmin) return alert('Admins only');
  let idx=[]; try{ const arr=await ghGet('moments'); for(const it of (arr||[])){ if(it.type==='file' && it.name.endsWith('.json')){ try{ const j=await (await fetch(it.download_url)).json(); idx.push({ id:j.id, author:j.author, kind:j.kind||'image', caption:j.caption||'', tags:j.tags||[], link:j.link||null, media_url:j.media_url, created_at:j.created_at}); }catch{} } } }catch{}
  idx.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)); await upsertText(IDX.moments, JSON.stringify(idx,null,2), 'rebuild moments index'); sessionStorage.removeItem('mh:index:moments'); toast('Indexes rebuilt'); };

// ---------- Boot ----------
(async ()=>{
  // Connect defaults are applied when opening the modal (Part 2), but we can prefill quietly too:
  try{ presetRepoDefaults?.(); }catch{}
  // Initial UI
  await loadStories().catch(()=>{});
  await loadFeed().catch(()=>{});
  await loadVertical().catch(()=>{});
  await restoreAppUser().catch(()=>{});
})();
</script>
  </html>
